<?xml version="1.0" encoding="utf-8"?>
<!--
Copyright (C) Villanova University 2012.

This program is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License version 2,
as published by the Free Software Foundation.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
-->
<xforms:model id="CoreModel-helper"
              xmlns:xhtml="http://www.w3.org/1999/xhtml"
              xmlns:xforms="http://www.w3.org/2002/xforms"
              xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
              xmlns:ev="http://www.w3.org/2001/xml-events"
              xmlns:xs="http://www.w3.org/2001/XMLSchema"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
              xmlns:xi="http://www.w3.org/2001/XInclude"
              xmlns:foxml="info:fedora/fedora-system:def/foxml#"
              xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
              xmlns:sparql="http://www.w3.org/2001/sw/DataAccess/rf1/result"
              xmlns:fedora-model="info:fedora/fedora-system:def/model#" 
              xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" 
              xmlns:rel="info:fedora/fedora-system:def/relations-external#"
              xmlns:dc="http://purl.org/dc/elements/1.1/"
              xmlns:management="http://www.fedora.info/definitions/1/0/management/"
              xmlns:access="http://www.fedora.info/definitions/1/0/access/"
              xmlns:oai_dc="http://www.openarchives.org/OAI/2.0/oai_dc/"
              xmlns:METS="http://www.loc.gov/METS/"
              xmlns:composite-model="info:fedora/fedora-system:def/dsCompositeModel#"
              xmlns:oai="http://www.openarchives.org/OAI/2.0/"
              xmlns:fedora-types="http://www.fedora.info/definitions/1/0/types/"
              xmlns:fits="http://hul.harvard.edu/ois/xml/ns/fits/fits_output"
              xmlns:vudl="http://vudl.org"
              >

    <xforms:action ev:event="perform-findObjects">
        <xforms:setvalue ref="xxforms:instance('findObjects-parameters')/destination-instance" value="string('findObjects-instance')"/>
        <xforms:setvalue ref="xxforms:instance('findObjects-parameters')/parameters/resultFormat" value="string('xml')"/>
        <xforms:setvalue ref="xxforms:instance('findObjects-parameters')/parameters/pid" value="string('true')"/>
        <xforms:setvalue ref="xxforms:instance('findObjects-parameters')/parameters/label" value="string('true')"/>
        <xforms:setvalue ref="xxforms:instance('findObjects-parameters')/parameters/title" value="string('true')"/>
        <xforms:setvalue ref="xxforms:instance('findObjects-parameters')/parameters/description" value="string('true')"/>
        <xforms:setvalue ref="xxforms:instance('findObjects-parameters')/parameters/ownerId" value="string('true')"/>
        <xforms:setvalue ref="xxforms:instance('findObjects-parameters')/parameters/state" value="string('true')"/>
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects')"/>
            <xxforms:context name="dsID" value="string('')"/>
            <xxforms:context name="apiMethod" value="string('findObjects')"/>
            <xxforms:context name="httpMethod" value="string('get')"/>
            <xxforms:context name="mode" value="string('synchronous')"/>
            <xxforms:context name="destination-instance" value="xxforms:instance('findObjects-parameters')/destination-instance"/>
            <xxforms:context name="clear-destination-instance" value="string('true')"/>
            <xxforms:context name="parameters" value="string('findObjects-parameters')"/>
            <xxforms:context name="completion-event" value="string('update-after-findObjects-metadata')"/>
        </xforms:dispatch>
    </xforms:action>
    
    <xforms:action ev:event="get-all-required-datastreams">
        <!-- Grab all required datastreams for every ModelType -->
        <xforms:action xxforms:iterate="xxforms:instance('ModelTypes')/root()//ModelType">
            <xxforms:variable name="systemModelPID" value="substring-after(./@uri, 'info:fedora/')"/>
            <!-- getDatastream: DS-COMPOSITE-MODEL -->
            <!-- xxforms:instance('all-required-datastreams-instance') -->
            <!-- -->
            <xforms:dispatch name="performAPIRequest" 
                             target="FedoraAPI-helper"
                             xxforms:show-progress="true">
                <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', $systemModelPID, '/datastreams/', string('DS-COMPOSITE-MODEL'), '?format=', string('xml'), '&amp;asOfDateTime=', now(),'&amp;validateChecksum=', string('false'))"/>
                <xxforms:context name="dsID" value="string('DS-COMPOSITE-MODEL')"/>
                <xxforms:context name="apiMethod" value="string('getDatastream')"/>
                <xxforms:context name="httpMethod" value="string('get')"/>
                <xxforms:context name="mode" value="string('synchronous')"/>
                <xxforms:context name="destination-instance" value="string('all-required-datastreams-instance')"/>
                <xxforms:context name="clear-destination-instance" value="string('false')"/>
            </xforms:dispatch>
            <!-- getDatastreamDissemination: DS-COMPOSITE-MODEL -->
            <!-- DS-COMPOSITE-MODEL-temp-instance to: xxforms:instance('all-required-datastreams-instance') -->
            <!-- -->
            <xforms:dispatch name="performAPIRequest" 
                             target="FedoraAPI-helper"
                             xxforms:show-progress="true">
                <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', $systemModelPID, '/datastreams/', string('DS-COMPOSITE-MODEL'), '/content?asOfDateTime=', now())"/>
                <xxforms:context name="dsID" value="string('DS-COMPOSITE-MODEL')"/>
                <xxforms:context name="apiMethod" value="string('getDatastreamDissemination')"/>
                <xxforms:context name="httpMethod" value="string('get')"/>
                <xxforms:context name="mode" value="string('synchronous')"/>
                <xxforms:context name="destination-instance" value="string('DS-COMPOSITE-MODEL-temp-instance')"/>
                <xxforms:context name="clear-destination-instance" value="string('true')"/>
            </xforms:dispatch>
            <!-- -->
            <xforms:insert context="xxforms:instance('all-required-datastreams-instance')/management:datastreamProfile[@pid = $systemModelPID]"
                           origin="xxforms:instance('DS-COMPOSITE-MODEL-temp-instance')/root()/instance/composite-model:dsCompositeModel"
                           at="last()"
                           position="after"
                           />
        </xforms:action>
    </xforms:action>
    
    <xforms:action ev:event="browse-members-goto-object">
        <xforms:load resource="/VuDL/object/{event('PID')}"/>
    </xforms:action>
    
    <xforms:action ev:event="browse-members-set-PID">
        <xforms:setvalue ref="xxforms:instance(concat(event('browse-members-target'), '-selected'))" value="event('PID')"/>
    </xforms:action>
    
    <xforms:action ev:event="browse-members-selected-methods">
        <xforms:setvalue ref="xxforms:instance(concat(event('browse-members-target'), '-selected'))" value="event('PID')"/>
        
        <xforms:setvalue ref="xxforms:instance('upload-DATA-selected-method')" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-external-url')" value="string('')"/>

        <xforms:setvalue ref="xxforms:instance('listMethods-parameters')/PID" value="event('PID')"/>
        <xforms:setvalue ref="xxforms:instance('listMethods-parameters')/destination-instance" value="string('upload-DATA-methods')"/>
        <xforms:setvalue ref="xxforms:instance('listMethods-parameters')/parameters/format" value="string('xml')"/>
        <xforms:setvalue ref="xxforms:instance('listMethods-parameters')/parameters/asOfDateTime" value="now()"/>
        <!-- Grab available methods for this object -->
        <!-- xxforms:instance('listMethods-dialog-instance') -->
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('listMethods-parameters')/PID, '/methods?format=', string('xml'), '&amp;asOfDateTime=', now())"/>               
            <xxforms:context name="apiMethod" value="string('listMethods')"/>
            <xxforms:context name="httpMethod" value="string('get')"/>
            <xxforms:context name="mode" value="string('synchronous')"/>
            <xxforms:context name="destination-instance" value="string('upload-DATA-methods')"/>
            <xxforms:context name="clear-destination-instance" value="string('true')"/>
        </xforms:dispatch>
        <!-- ~~~~~~~~~~~~~~~~ -->
        <!-- <xforms:send submission="listMethods" model="RestAPIModel-model"/> -->
    </xforms:action>

    <xforms:action ev:event="browse-members">
        <!-- -->
        <xxforms:variable name="browse-members-target" value="string('')"/>
        
        <xforms:action if="string-length(event('browse-members-target')) > 0">
            <xforms:setvalue ref="xxforms:instance('browse-members-target')" value="event('browse-members-target')"/>
        </xforms:action>
        
        <xxforms:variable name="browse-members-target" value="xxforms:instance('browse-members-target')"/>
        <xxforms:variable name="browse-members-target-instance" value="concat($browse-members-target, '-instance')"/>
        <xxforms:variable name="browse-members-target-parameters" value="concat($browse-members-target, '-parameters')"/>

        <!-- PARENT-LIST-RAW: getDatastreamDissemination -->
        <!-- xxforms:instance('PARENT-LIST-RAW-dialog-instance') 
        <xforms:dispatch name="performAPIRequest" 
             target="FedoraAPI-helper"
             xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance($browse-members-target-parameters)/vudl:PID, '/datastreams/', string('PARENT-LIST-RAW'), '/content?format=', string('xml'), '&amp;asOfDateTime=', now(),'&amp;validateChecksum=', string('false'))"/>
            <xxforms:context name="dsID" value="string('PARENT-LIST-RAW')"/>
            <xxforms:context name="apiMethod" value="string('getDatastreamDissemination')"/>
            <xxforms:context name="httpMethod" value="string('get')"/>
            <xxforms:context name="mode" value="string('synchronous')"/>
            <xxforms:context name="destination-instance" value="string('PARENT-LIST-RAW-dialog-instance')"/>
            <xxforms:context name="clear-destination-instance" value="string('true')"/>
        </xforms:dispatch>
        -->
        <!-- -->
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/PID" value="xxforms:instance($browse-members-target-parameters)/vudl:PID"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/destination-instance" value="string('PARENT-LIST-RAW-dialog-instance')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/clear-destination-instance" value="string('true')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/relationship" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/flush" value="string('false')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/lang" value="string('itql')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/format" value="string('Sparql')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/limit" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/distinct" value="string('off')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/stream" value="string('off')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/query" value="replace(xxforms:instance('get-all-parents-query'), 'XXX:XXX', xxforms:instance('risearchQuery-parameters')/PID)"/>

        <xforms:dispatch name="risearchQuery-prep-query" target="FedoraAPI-helper"/>

        <xforms:dispatch name="performAPIRequest"
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true"
                         >
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/risearch?asOfDataTime=', now())"/>
            <xxforms:context name="dsID" value="string('')"/>
            <xxforms:context name="apiMethod" value="string('risearchQuery')"/>
            <xxforms:context name="httpMethod" value="string('post')"/>
            <xxforms:context name="mode" value="string('synchronous')"/>
            <xxforms:context name="destination-instance" value="xxforms:instance('risearchQuery-parameters')/destination-instance"/>
            <xxforms:context name="clear-destination-instance" value="xxforms:instance('risearchQuery-parameters')/clear-destination-instance"/>
        </xforms:dispatch>
        
        <!-- -->
        <xxforms:variable name="parent" value="xxforms:instance('PARENT-LIST-RAW-dialog-instance')//sparql:child[@uri = concat('info:fedora/', xxforms:instance($browse-members-target-parameters)/vudl:PID)]/parent::*"/>
        <xxforms:variable name="parentURI" value="$parent[1]/sparql:parent/@uri"/>
        <xxforms:variable name="parentPID" value="substring-after($parentURI, 'info:fedora/')"/>
        <xxforms:variable name="parentLabel" value="$parent[1]/sparql:parentTitle"/>
        <xforms:setvalue ref="xxforms:instance($browse-members-target-parameters)/vudl:parentPID" value="$parentPID"/>
        
        <!-- -->
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/PID" value="xxforms:instance($browse-members-target-parameters)/vudl:PID"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/destination-instance" value="string('MEMBER-LIST-RAW-temp-instance')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/clear-destination-instance" value="string('true')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/relationship" value="xxforms:instance($browse-members-target-parameters)/vudl:relationship"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/flush" value="string('false')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/lang" value="string('itql')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/format" value="string('Sparql')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/limit" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/distinct" value="string('off')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/stream" value="string('off')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/query" value="replace(replace(xxforms:instance('getMembers-query'), 'VUDL_RELATIONSHIP', xxforms:instance('risearchQuery-parameters')/relationship), 'XXX:XXX', xxforms:instance($browse-members-target-parameters)/vudl:PID)"/>

        <xforms:dispatch name="risearchQuery-prep-query" target="FedoraAPI-helper"/>

        <xforms:dispatch name="performAPIRequest"
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true"
                         >
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/risearch?asOfDataTime=', now())"/>
            <xxforms:context name="dsID" value="string('')"/>
            <xxforms:context name="apiMethod" value="string('risearchQuery')"/>
            <xxforms:context name="httpMethod" value="string('post')"/>
            <xxforms:context name="mode" value="string('synchronous')"/>
            <xxforms:context name="destination-instance" value="xxforms:instance('risearchQuery-parameters')/destination-instance"/>
            <xxforms:context name="clear-destination-instance" value="xxforms:instance('risearchQuery-parameters')/clear-destination-instance"/>
        </xforms:dispatch>

        <!-- initial load -->
        <xforms:action if="not(xxforms:instance($browse-members-target-instance)/root()/instance/sparql:sparql)">
            <xforms:insert context="xxforms:instance('MEMBER-LIST-RAW-temp-instance')/root()/instance/sparql:sparql" origin="xforms:attribute('PID', xxforms:instance($browse-members-target-parameters)/vudl:PID)"/>
            <xforms:insert context="xxforms:instance($browse-members-target-instance)/root()/instance"
                           origin="xxforms:instance('MEMBER-LIST-RAW-temp-instance')/root()/instance/*"
                           at="last()"
                           position="after"
                           />
        </xforms:action>
        <xforms:action if="not(xxforms:instance($browse-members-target-instance)/root()/instance/*[name() = $browse-members-target-parameters])">
            <xforms:insert context="xxforms:instance($browse-members-target-instance)/root()/instance"
                           origin="xxforms:instance($browse-members-target-parameters)"
                           at="last()"
                           position="after"
                           />
        </xforms:action>
        
        <!-- Sub-collections -->
        <xforms:action if="not(xxforms:instance($browse-members-target-instance)//sparql:sparql[@PID = xxforms:instance($browse-members-target-parameters)/vudl:PID])">
            <xforms:insert context="xxforms:instance('MEMBER-LIST-RAW-temp-instance')/root()/instance/sparql:sparql" origin="xforms:attribute('PID', xxforms:instance($browse-members-target-parameters)/vudl:PID)"/>
            <xforms:insert context="xxforms:instance($browse-members-target-instance)//sparql:memberPID[. = xxforms:instance($browse-members-target-parameters)/vudl:PID]/parent::*"
                           origin="xxforms:instance('MEMBER-LIST-RAW-temp-instance')/root()/instance/*"
                           at="last()"
                           position="after"
                           />
        </xforms:action>
        
        <!-- 
        <xforms:dispatch name="browse-load-parameters"
                         target="CoreModel-helper"
                         delay="1"
                         >
            <xxforms:context name="container-PID" select="xxforms:instance($browse-members-target-parameters)/vudl:PID"/>
            <xxforms:context name="browse-members-target" select="$browse-members-target"/>
        </xforms:dispatch>
        -->
        <!-- -->
        <xforms:dispatch name="{$browse-members-target}-load-parameters"
                         target="CoreModel-helper"
                         
                         /> <!-- delay="1" -->
                         
        <!-- -->
        <xforms:dispatch name="{$browse-members-target}-load-metadata"
                         target="CoreModel-helper"
                         delay="1"
                         />

    </xforms:action>

    
    <xforms:action ev:event="browse-members-load-metadata">
        <xforms:dispatch name="browse-load-metadata"
                         target="CoreModel-helper"
                         >
            <xxforms:context name="container-PID" select="xxforms:instance('browse-members-parameters')/vudl:PID"/>
            <xxforms:context name="browse-members-target" select="string('browse-members')"/>
        </xforms:dispatch>
    </xforms:action>
    
    <xforms:action ev:event="browse-members-dialog-load-metadata">
        <xforms:dispatch name="browse-load-metadata"
                         target="CoreModel-helper"
                         >
            <xxforms:context name="container-PID" select="xxforms:instance('browse-members-dialog-parameters')/vudl:PID"/>
            <xxforms:context name="browse-members-target" select="string('browse-members-dialog')"/>
        </xforms:dispatch>
    </xforms:action>

    <xforms:action ev:event="browse-members-load-parameters">
        <xforms:dispatch name="browse-load-parameters"
                         target="CoreModel-helper"
                         >
            <xxforms:context name="container-PID" select="xxforms:instance('browse-members-parameters')/vudl:PID"/>
            <xxforms:context name="browse-members-target" select="string('browse-members')"/>
        </xforms:dispatch>
    </xforms:action>
    
    <xforms:action ev:event="browse-members-dialog-load-parameters">
        <xforms:dispatch name="browse-load-parameters"
                         target="CoreModel-helper"
                         >
            <xxforms:context name="container-PID" select="xxforms:instance('browse-members-dialog-parameters')/vudl:PID"/>
            <xxforms:context name="browse-members-target" select="string('browse-members-dialog')"/>
        </xforms:dispatch>
    </xforms:action>
    
    <!-- insert browse-parameters into sparql list -->
    <xforms:action ev:event="browse-load-parameters">

        <xxforms:variable name="container-PID" value="event('container-PID')"/>
        <xxforms:variable name="browse-members-target" value="event('browse-members-target')"/>
        <xxforms:variable name="browse-members-target-instance" value="concat($browse-members-target, '-instance')"/>
        <xxforms:variable name="browse-members-target-parameters" value="concat($browse-members-target, '-parameters')"/>

        <xxforms:variable name="container" select="xxforms:instance($browse-members-target-instance)//sparql:sparql[@PID = $container-PID]/parent::*"/>
        <xxforms:variable name="current-display" select="$container/*[name() = $browse-members-target-parameters]/vudl:current-display"/>
        
        <!-- 
        <xforms:message><xforms:output value="$container-PID"/></xforms:message>
        <xforms:message><xforms:output value="$browse-members-target-instance"/></xforms:message>
        <xforms:message><xforms:output value="$browse-members-target-parameters"/></xforms:message>
        <xforms:message><xforms:output value="$container/*[name() = $browse-members-target-parameters]/vudl:current-display"/></xforms:message>
        <xforms:message><xforms:output value="$current-display"/></xforms:message>
        -->
        
        <!-- Insert parameters -->
        <xforms:action xxforms:iterate="1 to $current-display">
            
            <xxforms:variable name="memberPosition" value="."/>

            <xxforms:variable name="PID" value="xxforms:instance($browse-members-target-instance)//sparql:sparql[@PID = $container-PID]/sparql:results/sparql:result[$memberPosition]/sparql:memberPID"/>
            <!-- <xxforms:variable name="member-container" select="xxforms:instance($browse-members-target-instance)//sparql:memberPID[. = $PID]/parent::*"/> -->
            <xxforms:variable name="member-container" select="xxforms:instance($browse-members-target-instance)//sparql:sparql[@PID = $container-PID]/sparql:results/sparql:result[$memberPosition]"/>

            <xforms:action if="(string-length($PID) > 0) and not($member-container/vudl:browse-members-parameters)">
                <!-- -->

                <xforms:insert context="$member-container"
                               origin="xxforms:instance($browse-members-target-parameters)"
                               at="last()"
                               position="after"
                               />
                <xforms:setvalue ref="$member-container/*[name() = $browse-members-target-parameters]/vudl:PID" value="$PID"/>
                
            </xforms:action>
        </xforms:action>

    </xforms:action>
    
    <xforms:action ev:event="browse-load-metadata">

        <xxforms:variable name="container-PID" value="event('container-PID')"/>
        <xxforms:variable name="browse-members-target" value="event('browse-members-target')"/>
        <xxforms:variable name="browse-members-target-instance" value="concat($browse-members-target, '-instance')"/>
        <xxforms:variable name="browse-members-target-parameters" value="concat($browse-members-target, '-parameters')"/>

        <xxforms:variable name="container" select="xxforms:instance($browse-members-target-instance)//sparql:sparql[@PID = $container-PID]/parent::*"/>
        <xxforms:variable name="current-display" select="$container/*[name() = $browse-members-target-parameters]/vudl:current-display"/>
        
        <!-- 
        <xforms:message><xforms:output value="$container-PID"/></xforms:message>
        <xforms:message><xforms:output value="$browse-members-target-instance"/></xforms:message>
        <xforms:message><xforms:output value="$browse-members-target-parameters"/></xforms:message>
        <xforms:message><xforms:output value="$container/*[name() = $browse-members-target-parameters]/vudl:current-display"/></xforms:message>
        <xforms:message><xforms:output value="$current-display"/></xforms:message>
        -->

        <!-- Load Metadata -->
        <xforms:action xxforms:iterate="1 to $current-display">

            <xxforms:variable name="memberPosition" value="."/>

            <xxforms:variable name="PID" value="xxforms:instance($browse-members-target-instance)//sparql:sparql[@PID = $container-PID]/sparql:results/sparql:result[$memberPosition]/sparql:memberPID"/>

            
            
            <xxforms:variable name="member-container" select="xxforms:instance($browse-members-target-instance)//sparql:memberPID[. = $PID]/parent::*"/>

            <xforms:action if="string-length($PID) > 0">
                <xforms:dispatch name="load-PIDmetadata" 
                                 target="CoreModel-helper"
                                 >
                    <xxforms:context name="PID" select="$PID"/>
                    <xxforms:context name="mode" select="string('asynchronous')"/>
                    <xxforms:context name="stats" select="string('true')"/>
                </xforms:dispatch>
            </xforms:action>
            
            
         </xforms:action>
    </xforms:action>

    <xforms:action ev:event="load-dialog-MEMBER-LIST-RAW">
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/PID" value="xxforms:instance('edit-members-parameters')/PID"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/destination-instance" value="string('MEMBER-LIST-RAW-dialog-instance')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/clear-destination-instance" value="string('true')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/relationship" value="xxforms:instance('edit-members-parameters')/relationship"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/flush" value="string('false')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/lang" value="string('itql')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/format" value="string('Sparql')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/limit" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/distinct" value="string('off')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/stream" value="string('off')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/query" value="replace(replace(xxforms:instance('getMembers-query'), 'VUDL_RELATIONSHIP', xxforms:instance('risearchQuery-parameters')/relationship), 'XXX:XXX', xxforms:instance('risearchQuery-parameters')/PID)"/>

        <xforms:dispatch name="risearchQuery-prep-query" target="FedoraAPI-helper"/>

        <xforms:dispatch name="performAPIRequest"
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true"
                         >
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/risearch?asOfDataTime=', now())"/>
            <xxforms:context name="dsID" value="string('')"/>
            <xxforms:context name="apiMethod" value="string('risearchQuery')"/>
            <xxforms:context name="httpMethod" value="string('post')"/>
            <xxforms:context name="mode" value="string('synchronous')"/>
            <xxforms:context name="destination-instance" value="xxforms:instance('risearchQuery-parameters')/destination-instance"/>
            <xxforms:context name="clear-destination-instance" value="xxforms:instance('risearchQuery-parameters')/clear-destination-instance"/>
        </xforms:dispatch>
        
        <xforms:dispatch name="load-dialog-MEMBER-TABLE-metadata"
                         target="CoreModel-helper"
                         delay="1"
                         />
                         
    </xforms:action>

    
    <xforms:action ev:event="load-dialog-STRUCTMAP">

        <!-- Get STRUCTMAP -->
        <!-- ~~~~~~~~~~~~~~~~ -->
        <!-- STRUCTMAP: getDatastream -->
        <!-- xxforms:instance('STRUCTMAP-dialog-datastream-instance') -->
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('edit-members-parameters')/PID, '/datastreams/', string('STRUCTMAP'), '?format=', string('xml'), '&amp;asOfDateTime=', now(),'&amp;validateChecksum=', string('false'))"/>
            <xxforms:context name="dsID" value="string('STRUCTMAP')"/>
            <xxforms:context name="apiMethod" value="string('getDatastream')"/>
            <xxforms:context name="httpMethod" value="string('get')"/>
            <xxforms:context name="mode" value="string('synchronous')"/>
            <xxforms:context name="destination-instance" value="string('STRUCTMAP-dialog-datastream-instance')"/>
            <xxforms:context name="clear-destination-instance" value="string('true')"/>
        </xforms:dispatch>
        <!-- STRUCTMAP: getDatastreamDissemination -->
        <!-- xxforms:instance('STRUCTMAP-dialog-instance') -->
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('edit-members-parameters')/PID, '/datastreams/', string('STRUCTMAP'), '/content?format=', string('xml'), '&amp;asOfDateTime=', now(),'&amp;validateChecksum=', string('false'))"/>
            <xxforms:context name="dsID" value="string('STRUCTMAP')"/>
            <xxforms:context name="apiMethod" value="string('getDatastreamDissemination')"/>
            <xxforms:context name="httpMethod" value="string('get')"/>
            <xxforms:context name="mode" value="string('synchronous')"/>
            <xxforms:context name="destination-instance" value="string('STRUCTMAP-dialog-instance')"/>
            <xxforms:context name="clear-destination-instance" value="string('true')"/>
        </xforms:dispatch>
        <!-- ~~~~~~~~~~~~~~~~ -->

        <!-- Load Metadata 
        <xforms:delete nodeset="xxforms:instance('MEMBER-TABLE-dialog-getObjectProfile-instance')/root()/instance/*"/>
        <xforms:delete nodeset="xxforms:instance('MEMBER-TABLE-dialog-listDatastreams-instance')/root()/instance/*"/>
        <xforms:delete nodeset="xxforms:instance('MEMBER-TABLE-dialog-DC-instance')/root()/instance/*"/>
        -->
        <xforms:dispatch name="load-dialog-MEMBER-TABLE-metadata"
                         target="CoreModel-helper"
                         delay="1"
                         />
        
    </xforms:action>

    <xforms:action ev:event="load-dialog-MEMBER-TABLE-metadata">
        
        <!-- -->
        <!-- <xforms:action xxforms:iterate="xxforms:instance('STRUCTMAP-dialog-instance')//METS:div"> -->
        <xforms:action xxforms:iterate="xxforms:instance('MEMBER-TABLE-dialog-parameters')/from to xxforms:instance('MEMBER-TABLE-dialog-parameters')/to">
            <xxforms:variable name="collectionPosition" value="."/>

            <xforms:action if=".[xxforms:instance('edit-members-parameters')/ordered = 'true']">
                <xforms:setvalue ref="xxforms:instance('edit-members-parameters')/childPID" value="xxforms:instance('STRUCTMAP-dialog-instance')/METS:structMap/METS:div[$collectionPosition]/METS:fptr/@FILEID"/>
            </xforms:action>
            <xforms:action if=".[xxforms:instance('edit-members-parameters')/ordered = 'false']">
                <xforms:setvalue ref="xxforms:instance('edit-members-parameters')/childPID" value="xxforms:instance('MEMBER-LIST-RAW-dialog-instance')//sparql:result[$collectionPosition]/sparql:memberPID"/>
            </xforms:action>
            
            <xxforms:variable name="PID" value="xxforms:instance('edit-members-parameters')/childPID"/>

            <xforms:action if="string-length($PID) > 0">
            
                <xforms:dispatch name="load-PIDmetadata" 
                                 target="CoreModel-helper"
                                 >
                    <xxforms:context name="PID" select="$PID"/>
                    <xxforms:context name="mode" select="string('asynchronous')"/>
                    <xxforms:context name="stats" select="string('false')"/>
                </xforms:dispatch>

            </xforms:action>
            
         </xforms:action>
         
    </xforms:action>
    
    <xforms:action ev:event="load-PIDmetadata">
        <xxforms:variable name="PID" value="event('PID')"/>
        <xxforms:variable name="mode" value="event('mode')"/>
        <xxforms:variable name="stats" value="event('stats')"/>
        <!-- -->
        <xforms:action if="not(xxforms:instance('PIDmetadata')/object[@pid = $PID])">
            <xforms:insert context="xxforms:instance('PIDmetadata')/root()/instance"
                           origin="xxforms:instance('PIDmetadata-template')"
                           at="last()"
                           position="after"
                           />
            <xforms:setvalue ref="xxforms:instance('PIDmetadata')//object[@pid = '']/@pid" value="$PID"/>
        </xforms:action>
        
        <!-- Get DC -->
        <!-- ~~~~~~~~~~~~~~~~ -->
        <!-- <xforms:delete nodeset="xxforms:instance('PIDmetadata')/object[@pid = $PID]/management:datastreamProfile[@dsID = 'DC']"/> -->
        
        <!-- DC: getDatastream -->
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true"
                         if="not(xxforms:instance('PIDmetadata')/object[@pid = $PID]/management:datastreamProfile[@dsID = 'DC'])"
                         >
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', $PID, '/datastreams/', string('DC'), '?format=', string('xml'), '&amp;asOfDateTime=', now(),'&amp;validateChecksum=', string('false'))"/>
            <xxforms:context name="dsID" value="string('DC')"/>
            <xxforms:context name="apiMethod" value="string('getDatastream')"/>
            <xxforms:context name="httpMethod" value="string('get')"/>
            <xxforms:context name="mode" value="$mode"/>
            <xxforms:context name="destination-instance" value="string('MEMBER-TABLE-dialog-DC-datastream-instance')"/>
            <xxforms:context name="clear-destination-instance" value="string('false')"/>
            <xxforms:context name="completion-event" select="string('update-PIDmetadata-DC-datastream')"/>
            <xxforms:context name="parameters" value="string('')"/>
            <xxforms:context name="PID" select="$PID"/>
        </xforms:dispatch>
        
        <!-- DC: getDatastreamDissemination -->
        <!-- <xforms:delete nodeset="xxforms:instance('PIDmetadata')/object[@pid = $PID]/oai_dc:dc"/> -->
        <!-- -->
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true"
                         if="not(xxforms:instance('PIDmetadata')/object[@pid = $PID]/oai_dc:dc)"
                         >
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', $PID, '/datastreams/', string('DC'), '/content?format=', string('xml'), '&amp;asOfDateTime=', now(),'&amp;validateChecksum=', string('false'))"/>
            <xxforms:context name="dsID" value="string('DC')"/>
            <xxforms:context name="apiMethod" value="string('getDatastreamDissemination')"/>
            <xxforms:context name="httpMethod" value="string('get')"/>
            <xxforms:context name="mode" value="$mode"/>
            <xxforms:context name="destination-instance" value="string('MEMBER-TABLE-dialog-DC-instance')"/>
            <xxforms:context name="clear-destination-instance" value="string('true')"/>
            <xxforms:context name="completion-event" select="string('update-PIDmetadata-DC')"/>
            <xxforms:context name="parameters" value="string('')"/>
            <xxforms:context name="PID" select="$PID"/>
        </xforms:dispatch>
        
        
        <!-- ~~~~~~~~~~~~~~~~ -->
        <!-- listDatastreams -->
        <!-- <xforms:delete nodeset="xxforms:instance('PIDmetadata')/object[@pid = $PID]/access:objectDatastreams"/> -->
        <!-- -->
        <xforms:dispatch name="performAPIRequest"
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true"
                         if="not(xxforms:instance('PIDmetadata')/object[@pid = $PID]/access:objectDatastreams)"
                         >
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', $PID, '/datastreams?format=', string('xml'), '&amp;asOfDateTime=', now())"/>
            <xxforms:context name="apiMethod" value="string('listDatastreams')"/>
            <xxforms:context name="httpMethod" value="string('get')"/>
            <xxforms:context name="mode" value="$mode"/>
            <xxforms:context name="destination-instance" value="string('listDatastreams-temp-instance')"/>
            <xxforms:context name="clear-destination-instance" value="string('true')"/>
            <xxforms:context name="completion-event" select="string('update-PIDmetadata-listDatastreams')"/>
            <xxforms:context name="parameters" value="string('')"/>
            <xxforms:context name="PID" select="$PID"/>
        </xforms:dispatch>
        
        <!-- ~~~~~~~~~~~~~~~~ -->
        <!-- getObjectProfile -->
        <!-- <xforms:delete nodeset="xxforms:instance('PIDmetadata')/object[@pid = $PID]/access:objectProfile"/> -->
        <!-- -->
        <xforms:dispatch name="performAPIRequest"
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true"
                         if="not(xxforms:instance('PIDmetadata')/object[@pid = $PID]/access:objectProfile)"
                         >
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', $PID, '?format=', string('xml'), '&amp;asOfDateTime=', now())"/>
            <xxforms:context name="apiMethod" value="string('getObjectProfile')"/>
            <xxforms:context name="httpMethod" value="string('get')"/>
            <xxforms:context name="mode" value="$mode"/>
            <xxforms:context name="destination-instance" value="string('getObjectProfile-temp-instance')"/>
            <xxforms:context name="clear-destination-instance" value="string('true')"/>
            <xxforms:context name="completion-event" select="string('update-PIDmetadata-getObjectProfile')"/>
            <xxforms:context name="parameters" value="string('')"/>
            <xxforms:context name="PID" select="$PID"/>
        </xforms:dispatch>
        
        <!-- -->
        <xforms:action if="$stats = 'true'">
            
            <!-- Count Immediate Members -->
            <!-- <xforms:delete nodeset="xxforms:instance('PIDmetadata')/object[@pid = $PID]/sparql:sparql[@query-type = 'count-members']"/> -->
            <!-- -->
            <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/PID" value="$PID"/>
            <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/destination-instance" value="string('risearchQuery-temp-return')"/>
            <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/clear-destination-instance" value="string('true')"/>
            <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/flush" value="string('false')"/>
            <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/lang" value="string('itql')"/>
            <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/format" value="string('Sparql')"/>
            <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/limit" value="string('')"/>
            <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/distinct" value="string('off')"/>
            <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/stream" value="string('off')"/>
            <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/query" value="replace(xxforms:instance('count-members-query'), 'XXX:XXX', xxforms:instance('risearchQuery-parameters')/PID)"/>

            <xforms:dispatch name="risearchQuery-prep-query" target="FedoraAPI-helper"/>

            <xforms:dispatch name="performAPIRequest" 
                             target="FedoraAPI-helper"
                             xxforms:show-progress="true"
                             if="not(xxforms:instance('PIDmetadata')/object[@pid = $PID]/sparql:sparql[@query-type = 'count-members'])"
                             >
                <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/risearch?asOfDataTime=', now())"/>
                <xxforms:context name="dsID" value="string('')"/>
                <xxforms:context name="apiMethod" value="string('risearchQuery')"/>
                <xxforms:context name="httpMethod" value="string('post')"/>
                <xxforms:context name="mode" value="string('asynchronous')"/>
                <xxforms:context name="destination-instance" value="xxforms:instance('risearchQuery-parameters')/destination-instance"/>
                <xxforms:context name="clear-destination-instance" value="xxforms:instance('risearchQuery-parameters')/clear-destination-instance"/>
                <xxforms:context name="parameters" value="string('')"/>
                <xxforms:context name="PID" select="$PID"/>
                <xxforms:context name="completion-event" select="string('update-PIDmetadata-count-members')"/>
                <xxforms:context name="completion-event-param1" select="string('count-members')"/>
            </xforms:dispatch>
            
    
            <!-- Count Members Recursively -->
            <!-- <xforms:delete nodeset="xxforms:instance('PIDmetadata')/object[@pid = $PID]/sparql:sparql[@query-type = 'count-members-recursive']"/> -->
            <!-- -->
            <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/PID" value="$PID"/>
            <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/destination-instance" value="string('risearchQuery-temp-return')"/>
            <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/clear-destination-instance" value="string('false')"/>
            <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/flush" value="string('false')"/>
            <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/lang" value="string('itql')"/>
            <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/format" value="string('Sparql')"/>
            <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/limit" value="string('')"/>
            <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/distinct" value="string('off')"/>
            <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/stream" value="string('off')"/>
            <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/query" value="replace(xxforms:instance('count-members-recursive-query'), 'XXX:XXX', xxforms:instance('risearchQuery-parameters')/PID)"/>
    
            <xforms:dispatch name="risearchQuery-prep-query" target="FedoraAPI-helper"/>
    
            <xforms:dispatch name="performAPIRequest" 
                             target="FedoraAPI-helper"
                             xxforms:show-progress="true"
                             if="not(xxforms:instance('PIDmetadata')/object[@pid = $PID]/sparql:sparql[@query-type = 'count-members-recursive'])"
                             >
                <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/risearch?asOfDataTime=', now())"/>
                <xxforms:context name="dsID" value="string('')"/>
                <xxforms:context name="apiMethod" value="string('risearchQuery')"/>
                <xxforms:context name="httpMethod" value="string('post')"/>
                <xxforms:context name="mode" value="$mode"/>
                <xxforms:context name="destination-instance" value="xxforms:instance('risearchQuery-parameters')/destination-instance"/>
                <xxforms:context name="clear-destination-instance" value="xxforms:instance('risearchQuery-parameters')/clear-destination-instance"/>
                <xxforms:context name="parameters" value="string('')"/>
                <xxforms:context name="PID" select="$PID"/>
                <xxforms:context name="completion-event" select="string('update-PIDmetadata-count-members')"/>
                <xxforms:context name="completion-event-param1" select="string('count-members-recursive')"/>
            </xforms:dispatch>
            
        </xforms:action>

    </xforms:action>
    
    <xforms:action ev:event="purge-PIDmetadata">
        <xforms:delete nodeset="xxforms:instance('PIDmetadata')/object[@pid = event('PID')]"/>
    </xforms:action>
    
    <xforms:action ev:event="refresh-PIDmetadata">
        <xforms:delete nodeset="xxforms:instance('PIDmetadata')/object[@pid = event('PID')]"/>
        <xforms:dispatch name="load-PIDmetadata" 
                         target="CoreModel-helper"
                         >
            <xxforms:context name="PID" select="event('PID')"/>
            <xxforms:context name="mode" select="event('mode')"/>
            <xxforms:context name="stats" select="event('stats')"/>
        </xforms:dispatch>
    </xforms:action>
    
    <xforms:action ev:event="save-in-line-edits">
        <!-- Loop through everything in MEMBER-TABLE-dialog-DC-instance -->
        <!-- 
        <xforms:action xxforms:iterate="xxforms:instance('MEMBER-TABLE-dialog-DC-instance')//oai_dc:dc"> 
            <xxforms:variable name="PID" value="./dc:identifier"/>
        -->
        <!-- TODO: should we only loop though current view? -->
        <xforms:action xxforms:iterate="xxforms:instance('MEMBER-TABLE-dialog-parameters')/from to xxforms:instance('MEMBER-TABLE-dialog-parameters')/to">
            <xxforms:variable name="collectionPosition" value="."/>
            
            <xforms:action if=".[xxforms:instance('edit-members-parameters')/ordered = 'true']">
                <xforms:setvalue ref="xxforms:instance('edit-members-parameters')/childPID" value="xxforms:instance('STRUCTMAP-dialog-instance')/METS:structMap/METS:div[$collectionPosition]/METS:fptr/@FILEID"/>
            </xforms:action>
            <xforms:action if=".[xxforms:instance('edit-members-parameters')/ordered = 'false']">
                <xforms:setvalue ref="xxforms:instance('edit-members-parameters')/childPID" value="xxforms:instance('MEMBER-LIST-RAW-dialog-instance')//sparql:result[$collectionPosition]/sparql:memberPID"/>
            </xforms:action>
            
            <xxforms:variable name="PID" value="xxforms:instance('edit-members-parameters')/childPID"/>

            <xforms:action if="string-length($PID) > 0">
                <!-- insert ./ into DC-temp-instance -->
                <xforms:delete nodeset="xxforms:instance('DC-temp-instance')/root()/instance/*"/>
                <xforms:insert context="xxforms:instance('DC-temp-instance')/root()/instance"
                               origin="xxforms:instance('PIDmetadata')//dc:identifier[. = $PID]/parent::*"
                               at="last()"
                               position="after"
                               />
                <!-- modify datastream DC at $PID with DC-temp-instance -->
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/PID" value="$PID"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/dsID" value="string('DC')"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsLocation" value="string('')"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/altIDs" value="string('')"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsLabel" value="xxforms:instance('PIDmetadata')/management:datastreamProfile[@pid = $PID]/management:dsLabel"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/versionable" value="xxforms:instance('PIDmetadata')/management:datastreamProfile[@pid = $PID]/management:dsVersionable"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsState" value="xxforms:instance('PIDmetadata')/management:datastreamProfile[@pid = $PID]/management:dsState"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/formatURI" value="xxforms:instance('PIDmetadata')/management:datastreamProfile[@pid = $PID]/management:dsFormatURI"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/checksumType" value="xxforms:instance('PIDmetadata')/management:datastreamProfile[@pid = $PID]/management:dsChecksumType"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/checksum" value="xxforms:instance('PIDmetadata')/management:datastreamProfile[@pid = $PID]/management:dsChecksum"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/mimeType" value="xxforms:instance('PIDmetadata')/management:datastreamProfile[@pid = $PID]/management:dsMIME"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/logMessage" value="string('Modified DC Datastream')"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/ignoreContent" value="string('false')"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/lastModifiedDate" value="now()"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/post-content" value="string('DC-temp-instance')"/>
                <xforms:dispatch name="performAPIRequest"
                                 target="FedoraAPI-helper"
                                 xxforms:show-progress="true">
                    <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('modifyDatastream-parameters')/PID, '/datastreams/', xxforms:instance('modifyDatastream-parameters')/dsID)"/>
                    <xxforms:context name="dsID" value="xxforms:instance('modifyDatastream-parameters')/dsID"/>
                    <xxforms:context name="apiMethod" value="string('modifyDatastream')"/>
                    <xxforms:context name="httpMethod" value="string('put')"/>
                    <xxforms:context name="mode" value="string('')"/>
                    <xxforms:context name="destination-instance" value="string('')"/>
                    <xxforms:context name="clear-destination-instance" value="string('')"/>
                    <xxforms:context name="post-content" value="xxforms:instance('modifyDatastream-parameters')/post-content"/>
                    <xxforms:context name="parameters" value="string('modifyDatastream-parameters')"/>
                </xforms:dispatch>

                <!-- bind dc:title to the object label -->
                <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/PID" value="$PID"/>
                <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/label" value="encode-for-uri(substring(xxforms:instance('DC-temp-instance')//dc:title[1], 1, 150))"/>
                <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/ownerId" value="string('')"/>
                <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/state" value="string('')"/>
                <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/logMessage" value="string('Bind Label to dc:title')"/>
                <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/lastModifiedDate" value="now()"/>
                <xforms:dispatch name="performAPIRequest"
                                 target="FedoraAPI-helper"
                                 xxforms:show-progress="true">
                    <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('modifyObject-parameters')/PID)"/>
                    <xxforms:context name="dsID" value="string('')"/>
                    <xxforms:context name="apiMethod" value="string('modifyObject')"/>
                    <xxforms:context name="httpMethod" value="string('put')"/>
                    <xxforms:context name="mode" value="string('')"/>
                    <xxforms:context name="destination-instance" value="string('')"/>
                    <xxforms:context name="clear-destination-instance" value="string('')"/>
                    <xxforms:context name="post-content" value="string('')"/>
                    <xxforms:context name="parameters" value="string('modifyObject-parameters')"/>
                </xforms:dispatch>
                
                <!-- -->
                <xforms:dispatch name="refresh-PIDmetadata"
                                 target="CoreModel-helper"
                                 >
                    <xxforms:context name="PID" select="$PID"/>
                    <xxforms:context name="mode" select="string('asynchronous')"/>
                    <xxforms:context name="stats" select="string('true')"/>
                </xforms:dispatch>
                
            </xforms:action>
        </xforms:action>
        
        <!-- update parent ResourceCollection if one exists -->
        <xforms:dispatch name="update-parent-resource"
                         target="CoreModel-helper">
            <xxforms:context name="PID" value="xxforms:instance('edit-members-parameters')/PID"/>
        </xforms:dispatch>
        
        <!-- update self -->
        <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/PID" value="xxforms:instance('edit-members-parameters')/PID"/>
        <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/label" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/ownerId" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/state" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/logMessage" value="string('MEMBER-TABLE dc:title has changed')"/>
        <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/lastModifiedDate" value="now()"/>
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('modifyObject-parameters')/PID)"/>
            <xxforms:context name="apiMethod" value="string('modifyObject')"/>
            <xxforms:context name="httpMethod" value="string('put')"/>
            <xxforms:context name="mode" value="string('')"/>
            <xxforms:context name="destination-instance" value="string('')"/>
            <xxforms:context name="clear-destination-instance" value="string('')"/>
            <xxforms:context name="post-content" value="string('')"/>
            <xxforms:context name="parameters" value="string('modifyObject-parameters')"/>
        </xforms:dispatch>

    </xforms:action>
    
    <xforms:action ev:event="get-parent-resource">
    
        <!-- Prepare Query -->
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/PID" value="event('PID')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/destination-instance" value="string('parent-resource-raw')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/clear-destination-instance" value="string('true')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/flush" value="string('false')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/lang" value="string('itql')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/format" value="string('Sparql')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/limit" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/distinct" value="string('off')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/stream" value="string('off')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/query" value="replace(xxforms:instance('get-parent-resource-query'), 'XXX:XXX', xxforms:instance('risearchQuery-parameters')/PID)"/>
        <!-- -->
        <xforms:dispatch name="risearchQuery-prep-query" target="FedoraAPI-helper"/>
        <!-- -->
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/risearch?asOfDataTime=', now())"/>
            <xxforms:context name="dsID" value="string('')"/>
            <xxforms:context name="apiMethod" value="string('risearchQuery')"/>
            <xxforms:context name="httpMethod" value="string('post')"/>
            <xxforms:context name="mode" value="string('synchronous')"/>
            <xxforms:context name="destination-instance" value="xxforms:instance('risearchQuery-parameters')/destination-instance"/>
            <xxforms:context name="clear-destination-instance" value="xxforms:instance('risearchQuery-parameters')/clear-destination-instance"/>
        </xforms:dispatch>
        
        <xforms:delete nodeset="xxforms:instance('parent-resource')/*"/>
        <xforms:action xxforms:iterate="xxforms:instance('parent-resource-raw')//sparql:result">
            <xxforms:variable name="resourceURI" value="./sparql:parent/@uri"/>
            <xxforms:variable name="resourcePID" value="substring-after($resourceURI, 'info:fedora/')"/>
            <xforms:insert context="xxforms:instance('parent-resource')"
                           nodeset="PID"
                           origin="xxforms:instance('parent-resource-template')"
                           at="last()"
                           position="after"
                           />
            <xforms:setvalue ref="xxforms:instance('parent-resource')/PID[last()]" value="$resourcePID"/>
        </xforms:action>
        
    </xforms:action>
    
    <xforms:action ev:event="update-parent-resource">
        
        <xforms:dispatch name="get-parent-resource"
                         target="CoreModel-helper">
            <xxforms:context name="PID" value="event('PID')"/>
        </xforms:dispatch>

        <xforms:action xxforms:iterate="xxforms:instance('parent-resource')/PID">
            <!-- -->
            <xxforms:variable name="resourcePID" value="."/>
    
            <!-- Bind member DC edit to parent ResourceCollection -->
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/PID" value="$resourcePID"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/label" value="string('')"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/ownerId" value="string('')"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/state" value="string('')"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/logMessage" value="string('Bind member DC edit to parent ResourceCollection')"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/lastModifiedDate" value="now()"/>
            <!-- modifyObject -->
            <xforms:dispatch name="performAPIRequest" 
                             target="FedoraAPI-helper"
                             xxforms:show-progress="true">
                <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('modifyObject-parameters')/PID)"/>
                <xxforms:context name="apiMethod" value="string('modifyObject')"/>
                <xxforms:context name="httpMethod" value="string('put')"/>
                <xxforms:context name="mode" value="string('')"/>
                <xxforms:context name="destination-instance" value="string('')"/>
                <xxforms:context name="clear-destination-instance" value="string('')"/>
                <xxforms:context name="post-content" value="string('')"/>
                <xxforms:context name="parameters" value="string('modifyObject-parameters')"/>
            </xforms:dispatch>
            
        </xforms:action>
    </xforms:action>
    
    <xforms:action ev:event="load-findObjects-metadata">
        <xforms:action xxforms:iterate="xxforms:instance('findObjects-instance')//fedora-types:objectFields">
        
            <xxforms:variable name="PID" value="./fedora-types:pid"/>

            <!-- ~~~~~~~~~~~~~~~~ -->
            <!-- getObjectProfile -->
            <!-- xxforms:instance('findObjects-getObjectProfile-instance') -->
            <xforms:dispatch name="performAPIRequest"
                             target="FedoraAPI-helper"
                             xxforms:show-progress="true">
                <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', $PID, '?format=', string('xml'), '&amp;asOfDateTime=', now())"/>
                <xxforms:context name="apiMethod" value="string('getObjectProfile')"/>
                <xxforms:context name="httpMethod" value="string('get')"/>
                <xxforms:context name="mode" value="string('asynchronous')"/>
                <xxforms:context name="destination-instance" value="string('findObjects-getObjectProfile-instance')"/>
                <xxforms:context name="clear-destination-instance" value="string('false')"/>
                <xxforms:context name="PID" select="$PID"/>
            </xforms:dispatch>
            
            <!-- Grab available datastreams for this object -->
            <!-- xxforms:instance('findObjects-listDatastreams-instance') -->
            <xforms:dispatch name="performAPIRequest" 
                             target="FedoraAPI-helper"
                             xxforms:show-progress="true">
                <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', $PID, '/datastreams?format=', string('xml'), '&amp;asOfDateTime=', now())"/>
                <xxforms:context name="apiMethod" value="string('listDatastreams')"/>
                <xxforms:context name="httpMethod" value="string('get')"/>
                <xxforms:context name="mode" value="string('asynchronous')"/>
                <xxforms:context name="destination-instance" value="string('findObjects-listDatastreams-instance')"/>
                <xxforms:context name="clear-destination-instance" value="string('false')"/>
                <xxforms:context name="PID" select="$PID"/>
            </xforms:dispatch>

            <!-- PARENT-LIST: getDatastreamDissemination -->
            <!-- xxforms:instance('findObjects-PARENT-LIST-instance') 
            <xforms:dispatch name="performAPIRequest" 
                             target="FedoraAPI-helper"
                             xxforms:show-progress="true">
                <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', $PID, '/datastreams/', string('PARENT-LIST'), '/content?format=', string('xml'), '&amp;asOfDateTime=', now(),'&amp;validateChecksum=', string('false'))"/>
                <xxforms:context name="dsID" value="string('PARENT-LIST')"/>
                <xxforms:context name="apiMethod" value="string('getDatastreamDissemination')"/>
                <xxforms:context name="httpMethod" value="string('get')"/>
                <xxforms:context name="mode" value="string('synchronous')"/>
                <xxforms:context name="destination-instance" value="string('findObjects-PARENT-LIST-instance')"/>
                <xxforms:context name="clear-destination-instance" value="string('false')"/>
            </xforms:dispatch>
            -->
            <!-- -->

            <!-- ~~~~~~~~~~~~~~~~ -->
            
        </xforms:action>
    </xforms:action>
    
    <xforms:action ev:event="prepPurge">

        <!-- Get PARENT-LIST-RAW -->
        <!-- ~~~~~~~~~~~~~~~~ -->
        <!-- PARENT-LIST-RAW: getDatastream -->
        <!-- xxforms:instance('PARENT-LIST-RAW-dialog-datastream-instance') -->
        <xforms:dispatch name="performAPIRequest" 
             target="FedoraAPI-helper"
             xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('purgeTree-parameters')/PID, '/datastreams/', string('PARENT-LIST-RAW'), '?format=', string('xml'), '&amp;asOfDateTime=', now(),'&amp;validateChecksum=', string('false'))"/>
            <xxforms:context name="dsID" value="string('PARENT-LIST-RAW')"/>
            <xxforms:context name="apiMethod" value="string('getDatastream')"/>
            <xxforms:context name="httpMethod" value="string('get')"/>
            <xxforms:context name="mode" value="string('synchronous')"/>
            <xxforms:context name="destination-instance" value="string('PARENT-LIST-RAW-dialog-datastream-instance')"/>
            <xxforms:context name="clear-destination-instance" value="string('true')"/>
        </xforms:dispatch>
        
        <!-- PARENT-LIST-RAW: getDatastreamDissemination -->
        <!-- xxforms:instance('PARENT-LIST-RAW-dialog-instance') -->
        <xforms:dispatch name="performAPIRequest" 
             target="FedoraAPI-helper"
             xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('purgeTree-parameters')/PID, '/datastreams/', string('PARENT-LIST-RAW'), '/content?format=', string('xml'), '&amp;asOfDateTime=', now(),'&amp;validateChecksum=', string('false'))"/>
            <xxforms:context name="dsID" value="string('PARENT-LIST-RAW')"/>
            <xxforms:context name="apiMethod" value="string('getDatastreamDissemination')"/>
            <xxforms:context name="httpMethod" value="string('get')"/>
            <xxforms:context name="mode" value="string('synchronous')"/>
            <xxforms:context name="destination-instance" value="string('PARENT-LIST-RAW-dialog-instance')"/>
            <xxforms:context name="clear-destination-instance" value="string('true')"/>
        </xforms:dispatch>
        <!-- ~~~~~~~~~~~~~~~~ -->
            
        <!-- Prepare Query -->
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/PID" value="xxforms:instance('purgeTree-parameters')/PID"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/destination-instance" value="string('all-children-temp-raw')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/clear-destination-instance" value="string('true')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/flush" value="string('false')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/lang" value="string('itql')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/format" value="string('Sparql')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/limit" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/distinct" value="string('off')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/stream" value="string('off')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/query" value="replace(xxforms:instance('getAllChildren-query'), 'XXX:XXX', xxforms:instance('risearchQuery-parameters')/PID)"/>
        <!-- -->
        <xforms:dispatch name="risearchQuery-prep-query" target="FedoraAPI-helper"/>
        <!-- -->
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/risearch?asOfDataTime=', now())"/>
            <xxforms:context name="dsID" value="string('')"/>
            <xxforms:context name="apiMethod" value="string('risearchQuery')"/>
            <xxforms:context name="httpMethod" value="string('post')"/>
            <xxforms:context name="mode" value="string('synchronous')"/>
            <xxforms:context name="destination-instance" value="xxforms:instance('risearchQuery-parameters')/destination-instance"/>
            <xxforms:context name="clear-destination-instance" value="xxforms:instance('risearchQuery-parameters')/clear-destination-instance"/>
        </xforms:dispatch>

        <!-- -->
        <xforms:insert nodeset="xxforms:instance('all-children-temp-formatted')"
                       origin="xxforms:call-xpl('oxf:/apps/VuDL/xpl/children.xpl', ('data','PID'), (xxforms:instance(xxforms:instance('risearchQuery-parameters')/destination-instance), xxforms:instance('risearchQuery-parameters')/PID), 'data')"/>

    </xforms:action>
    
    <xforms:action ev:event="purgeTree">
        
        <!-- Start Processing -->
        <xforms:setvalue ref="xxforms:instance('purgeTree-parameters')/processing" value="string('true')"/>
        
        <!-- -->
        <xxforms:variable name="parentPID" value="substring-after(xxforms:instance('PARENT-LIST-RAW-dialog-instance')//sparql:child[@uri=concat('info:fedora/', xxforms:instance('purgeTree-parameters')/PID)]/parent::*/sparql:parent/@uri, 'info:fedora/')"/>
        <xforms:setvalue ref="xxforms:instance('purgeTree-parameters')/parentPID" value="$parentPID"/>
        
        <!-- Get parent's STRUCTMAP -->
        <!-- ~~~~~~~~~~~~~~~~ -->
        <!-- STRUCTMAP: getDatastream -->
        <!-- xxforms:instance('STRUCTMAP-dialog-datastream-instance') -->
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('purgeTree-parameters')/parentPID, '/datastreams/', string('STRUCTMAP'), '?format=', string('xml'), '&amp;asOfDateTime=', now(),'&amp;validateChecksum=', string('false'))"/>
            <xxforms:context name="dsID" value="string('STRUCTMAP')"/>
            <xxforms:context name="apiMethod" value="string('getDatastream')"/>
            <xxforms:context name="httpMethod" value="string('get')"/>
            <xxforms:context name="mode" value="string('synchronous')"/>
            <xxforms:context name="destination-instance" value="string('STRUCTMAP-dialog-datastream-instance')"/>
            <xxforms:context name="clear-destination-instance" value="string('true')"/>
        </xforms:dispatch>
        <!-- STRUCTMAP: getDatastreamDissemination -->
        <!-- xxforms:instance('STRUCTMAP-dialog-instance') -->
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('purgeTree-parameters')/parentPID, '/datastreams/', string('STRUCTMAP'), '/content?format=', string('xml'), '&amp;asOfDateTime=', now(),'&amp;validateChecksum=', string('false'))"/>
            <xxforms:context name="dsID" value="string('STRUCTMAP')"/>
            <xxforms:context name="apiMethod" value="string('getDatastreamDissemination')"/>
            <xxforms:context name="httpMethod" value="string('get')"/>
            <xxforms:context name="mode" value="string('synchronous')"/>
            <xxforms:context name="destination-instance" value="string('STRUCTMAP-dialog-instance')"/>
            <xxforms:context name="clear-destination-instance" value="string('true')"/>
        </xforms:dispatch>
        <!-- ~~~~~~~~~~~~~~~~ -->
        
        <!-- -->
        <xxforms:show dialog="purge-progress-dialog"/>

        <!-- Get RELS-EXT -->
        <!-- RELS-EXT: getDatastream -->
        <!-- xxforms:instance('RELS-EXT-temp-datastream-instance') -->
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('purgeTree-parameters')/PID, '/datastreams/', string('RELS-EXT'), '?format=', string('xml'), '&amp;asOfDateTime=', now(),'&amp;validateChecksum=', string('false'))"/>
            <xxforms:context name="dsID" value="string('RELS-EXT')"/>
            <xxforms:context name="apiMethod" value="string('getDatastream')"/>
            <xxforms:context name="httpMethod" value="string('get')"/>
            <xxforms:context name="mode" value="string('synchronous')"/>
            <xxforms:context name="destination-instance" value="string('RELS-EXT-temp-datastream-instance')"/>
            <xxforms:context name="clear-destination-instance" value="string('true')"/>
        </xforms:dispatch>
        <!-- RELS-EXT: getDatastreamDissemination -->
        <!-- xxforms:instance('RELS-EXT-temp-instance') -->
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('purgeTree-parameters')/PID, '/datastreams/', string('RELS-EXT'), '/content?format=', string('xml'), '&amp;asOfDateTime=', now(),'&amp;validateChecksum=', string('false'))"/>
            <xxforms:context name="dsID" value="string('RELS-EXT')"/>
            <xxforms:context name="apiMethod" value="string('getDatastreamDissemination')"/>
            <xxforms:context name="httpMethod" value="string('get')"/>
            <xxforms:context name="mode" value="string('synchronous')"/>
            <xxforms:context name="destination-instance" value="string('RELS-EXT-temp-instance')"/>
            <xxforms:context name="clear-destination-instance" value="string('true')"/>
        </xforms:dispatch>
        <!-- ~~~~~~~~~~~~~~~~ -->

    
        <!-- Do not delete selected item if is contained in other collections -->
        <!-- 1) remove selected PID from parent's RELS-EXT -->
        <xforms:delete nodeset="xxforms:instance('RELS-EXT-temp-instance')//rel:isMemberOf[@rdf:resource=concat('info:fedora/', xxforms:instance('purgeTree-parameters')/parentPID)]"/>
        <!-- -->
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/PID" value="xxforms:instance('purgeTree-parameters')/PID"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/dsID" value="string('RELS-EXT')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsLocation" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/altIDs" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsLabel" value="xxforms:instance('RELS-EXT-temp-datastream-instance')//management:dsLabel"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/versionable" value="xxforms:instance('RELS-EXT-temp-datastream-instance')//management:dsVersionable"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsState" value="xxforms:instance('RELS-EXT-temp-datastream-instance')//management:dsState"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/formatURI" value="xxforms:instance('RELS-EXT-temp-datastream-instance')//management:dsFormatURI"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/checksumType" value="xxforms:instance('RELS-EXT-temp-datastream-instance')//management:dsChecksumType"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/checksum" value="xxforms:instance('RELS-EXT-temp-datastream-instance')//management:dsChecksum"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/mimeType" value="xxforms:instance('RELS-EXT-temp-datastream-instance')//management:dsMIME"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/logMessage" value="string('Modified RELS-EXT Datastream')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/ignoreContent" value="string('false')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/lastModifiedDate" value="now()"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/post-content" value="string('RELS-EXT-temp-instance')"/>
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('modifyDatastream-parameters')/PID, '/datastreams/', xxforms:instance('modifyDatastream-parameters')/dsID)"/>
            <xxforms:context name="dsID" value="xxforms:instance('modifyDatastream-parameters')/dsID"/>
            <xxforms:context name="apiMethod" value="string('modifyDatastream')"/>
            <xxforms:context name="httpMethod" value="string('put')"/>
            <xxforms:context name="mode" value="string('')"/>
            <xxforms:context name="destination-instance" value="string('')"/>
            <xxforms:context name="clear-destination-instance" value="string('')"/>
            <xxforms:context name="post-content" value="xxforms:instance('modifyDatastream-parameters')/post-content"/>
            <xxforms:context name="parameters" value="string('modifyDatastream-parameters')"/>
        </xforms:dispatch>

        <!-- 2) If selected PID does not have any sibling isMemberOf's, Loop through the stuff below -->
        <xforms:action if="not(xxforms:instance('RELS-EXT-temp-instance')//rel:isMemberOf)">

            <!-- 
            foreach child with multiple parents (numParents gt 1)  
                remove membership from immediateParent
                you do not need to remove fptr from immediateParent's structmap becuase that will be deleted/purged
            -->
            <xforms:action xxforms:iterate="xxforms:instance('all-children-temp-formatted')//child[@numParents gt '1']">
                <xxforms:variable name="childPID" value="substring-after(./@uri, 'info:fedora/')"/>
                <xxforms:variable name="immediateParentURI" value="../@uri"/>
                <xxforms:variable name="immediateParentPID" value="substring-after(../@uri, 'info:fedora/')"/>
                
                <!-- RELS-EXT: getDatastream -->
                <!-- xxforms:instance('RELS-EXT-temp-datastream-instance') -->
                <xforms:dispatch name="performAPIRequest" 
                                 target="FedoraAPI-helper"
                                 xxforms:show-progress="true">
                    <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', $childPID, '/datastreams/', string('RELS-EXT'), '?format=', string('xml'), '&amp;asOfDateTime=', now(),'&amp;validateChecksum=', string('false'))"/>
                    <xxforms:context name="dsID" value="string('RELS-EXT')"/>
                    <xxforms:context name="apiMethod" value="string('getDatastream')"/>
                    <xxforms:context name="httpMethod" value="string('get')"/>
                    <xxforms:context name="mode" value="string('synchronous')"/>
                    <xxforms:context name="destination-instance" value="string('RELS-EXT-temp-datastream-instance')"/>
                    <xxforms:context name="clear-destination-instance" value="string('true')"/>
                </xforms:dispatch>
                <!-- RELS-EXT: getDatastreamDissemination -->
                <!-- xxforms:instance('RELS-EXT-temp-instance') -->
                <xforms:dispatch name="performAPIRequest" 
                                 target="FedoraAPI-helper"
                                 xxforms:show-progress="true">
                    <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', $childPID, '/datastreams/', string('RELS-EXT'), '/content?format=', string('xml'), '&amp;asOfDateTime=', now(),'&amp;validateChecksum=', string('false'))"/>
                    <xxforms:context name="dsID" value="string('RELS-EXT')"/>
                    <xxforms:context name="apiMethod" value="string('getDatastreamDissemination')"/>
                    <xxforms:context name="httpMethod" value="string('get')"/>
                    <xxforms:context name="mode" value="string('synchronous')"/>
                    <xxforms:context name="destination-instance" value="string('RELS-EXT-temp-instance')"/>
                    <xxforms:context name="clear-destination-instance" value="string('true')"/>
                </xforms:dispatch>
                <!-- ~~~~~~~~~~~~~~~~ -->

                <!-- remove isMemberOf immediateParentPID from childPID's RELS-EXT -->
                <xforms:delete nodeset="xxforms:instance('RELS-EXT-temp-instance')//rel:isMemberOf[@rdf:resource=$immediateParentURI]"/>
        
                <!-- update -->
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/PID" value="$childPID"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/dsID" value="string('RELS-EXT')"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsLocation" value="string('')"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/altIDs" value="string('')"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsLabel" value="xxforms:instance('RELS-EXT-temp-datastream-instance')//management:dsLabel"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/versionable" value="xxforms:instance('RELS-EXT-temp-datastream-instance')//management:dsVersionable"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsState" value="xxforms:instance('RELS-EXT-temp-datastream-instance')//management:dsState"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/formatURI" value="xxforms:instance('RELS-EXT-temp-datastream-instance')//management:dsFormatURI"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/checksumType" value="xxforms:instance('RELS-EXT-temp-datastream-instance')//management:dsChecksumType"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/checksum" value="xxforms:instance('RELS-EXT-temp-datastream-instance')//management:dsChecksum"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/mimeType" value="xxforms:instance('RELS-EXT-temp-datastream-instance')//management:dsMIME"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/logMessage" value="string('Modified RELS-EXT Datastream')"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/ignoreContent" value="string('false')"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/lastModifiedDate" value="now()"/>
                <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/post-content" value="string('RELS-EXT-temp-instance')"/>
                <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true">
                    <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('modifyDatastream-parameters')/PID, '/datastreams/', xxforms:instance('modifyDatastream-parameters')/dsID)"/>
                    <xxforms:context name="dsID" value="xxforms:instance('modifyDatastream-parameters')/dsID"/>
                    <xxforms:context name="apiMethod" value="string('modifyDatastream')"/>
                    <xxforms:context name="httpMethod" value="string('put')"/>
                    <xxforms:context name="mode" value="string('')"/>
                    <xxforms:context name="destination-instance" value="string('')"/>
                    <xxforms:context name="clear-destination-instance" value="string('')"/>
                    <xxforms:context name="post-content" value="xxforms:instance('modifyDatastream-parameters')/post-content"/>
                    <xxforms:context name="parameters" value="string('modifyDatastream-parameters')"/>
                </xforms:dispatch>

            </xforms:action>
            
            <!-- remove nodes where numParens gt 1 -->
            <xforms:delete nodeset="xxforms:instance('all-children-temp-formatted')//child[@numParents gt '1']"/>
            
            <xforms:setvalue ref="xxforms:instance('purgeTree-parameters')/total-objects" value="count(xxforms:instance('all-children-temp-formatted')//child)"/>
            <xforms:setvalue ref="xxforms:instance('purgeTree-parameters')/total" value="count(xxforms:instance('all-children-temp-formatted')//child)"/>
            
            <!-- loop through and purge //child -->
            <xforms:action xxforms:iterate="xxforms:instance('all-children-temp-formatted')//child">
                <xxforms:variable name="currentChild" value="."/>
                <xforms:insert context="xxforms:instance('purgeTree-parameters')/children"
                               origin="xxforms:instance('purge-object-child')"
                               at="last()"
                               position="after"/>
                <xforms:setvalue ref="xxforms:instance('purgeTree-parameters')/children/child[@uri='']/@name" value="$currentChild/@name"/>
                <xforms:setvalue ref="xxforms:instance('purgeTree-parameters')/children/child[@uri='']/@numParents" value="$currentChild/@numParents"/>
                <xforms:setvalue ref="xxforms:instance('purgeTree-parameters')/children/child[@uri='']/@uri" value="$currentChild/@uri"/>
            </xforms:action>

            <xforms:dispatch name="purgeObject-dispatch" target="CoreModel-helper" delay="1"/>
        </xforms:action>
        

        <!-- -->
        <xxforms:hide dialog="purge-object-dialog"/>
        
    </xforms:action>
    
    <!-- -->
    <xforms:action ev:event="purgeObject-dispatch">
        <xxforms:variable name="childPID" value="substring-after(xxforms:instance('purgeTree-parameters')/children/child[xxforms:instance('purgeTree-parameters')/file_position + 1]/@uri, 'info:fedora/')"/>
        <xforms:setvalue ref="xxforms:instance('purgeObject-parameters')/PID" value="$childPID"/> 
        <xforms:setvalue ref="xxforms:instance('purgeObject-parameters')/parameters/logMessage" value="concat('Removed by parent collection: ', xxforms:instance('purgeTree-parameters')/PID)"/>
        <xforms:send submission="purgeObject" model="FedoraAPI-helper"/>
        <xforms:dispatch name="purgeObject-iteration" target="CoreModel-helper"/>
    </xforms:action>
    
    <!-- -->
    <xforms:action ev:event="purgeObject-iteration">
        <xforms:setvalue ref="xxforms:instance('purgeTree-parameters')/current" value="xxforms:instance('purgeTree-parameters')/current + 1"/>
        <xforms:setvalue ref="xxforms:instance('purgeTree-parameters')/file_position" value="xxforms:instance('purgeTree-parameters')/file_position + 1"/>
        
        <xforms:action if="number(xxforms:instance('purgeTree-parameters')/file_position) ge number(xxforms:instance('purgeTree-parameters')/total)">
            <xforms:dispatch name="purgeObject-dispatch-end"  target="CoreModel-helper"/>
        </xforms:action>
        
        <xforms:action if="number(xxforms:instance('purgeTree-parameters')/file_position) lt number(xxforms:instance('purgeTree-parameters')/total)">
            <xforms:dispatch name="purgeObject-dispatch"  delay="1" target="CoreModel-helper"/>
        </xforms:action> 
    </xforms:action>
    
    <!-- -->
    <xforms:action ev:event="purgeObject-dispatch-end">

        <!-- -->
        <!-- remove div/fptr @ xxforms:instance('purgeTree-parameters')/PID from STRUCTMAP-dialog-instance, then update -->
        <xforms:delete nodeset="xxforms:instance('STRUCTMAP-dialog-instance')//METS:fptr[@FILEID=xxforms:instance('purgeTree-parameters')/PID]/parent::*"/>
        <!-- -->
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/PID" value="xxforms:instance('purgeTree-parameters')/parentPID"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/dsID" value="string('STRUCTMAP')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsLocation" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/altIDs" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsLabel" value="xxforms:instance('STRUCTMAP-dialog-datastream-instance')//management:dsLabel"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/versionable" value="xxforms:instance('STRUCTMAP-dialog-datastream-instance')//management:dsVersionable"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsState" value="xxforms:instance('STRUCTMAP-dialog-datastream-instance')//management:dsState"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/formatURI" value="xxforms:instance('STRUCTMAP-dialog-datastream-instance')//management:dsFormatURI"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/checksumType" value="xxforms:instance('STRUCTMAP-dialog-datastream-instance')//management:dsChecksumType"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/checksum" value="xxforms:instance('STRUCTMAP-dialog-datastream-instance')//management:dsChecksum"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/mimeType" value="xxforms:instance('STRUCTMAP-dialog-datastream-instance')//management:dsMIME"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/logMessage" value="string('Modified STRUCTMAP Datastream')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/ignoreContent" value="string('false')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/lastModifiedDate" value="now()"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/post-content" value="string('STRUCTMAP-dialog-instance')"/>
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('modifyDatastream-parameters')/PID, '/datastreams/', xxforms:instance('modifyDatastream-parameters')/dsID)"/>
            <xxforms:context name="dsID" value="xxforms:instance('modifyDatastream-parameters')/dsID"/>
            <xxforms:context name="apiMethod" value="string('modifyDatastream')"/>
            <xxforms:context name="httpMethod" value="string('put')"/>
            <xxforms:context name="mode" value="string('')"/>
            <xxforms:context name="destination-instance" value="string('')"/>
            <xxforms:context name="clear-destination-instance" value="string('')"/>
            <xxforms:context name="post-content" value="xxforms:instance('modifyDatastream-parameters')/post-content"/>
            <xxforms:context name="parameters" value="string('modifyDatastream-parameters')"/>
        </xforms:dispatch>
        <!-- <xforms:send submission="modifyDatastream" model="RestAPIModel-model"/> -->
        
        <!-- refresh rels 
        <xforms:dispatch name="refresh-RELS-EXT" target="CoreModel-model"/>
        -->
        
        <!-- refresh structmap 
        <xforms:setvalue ref="xxforms:instance('get-STRUCTMAP-parameters')/PID" value="xxforms:instance('currentPID')"/>
        <xforms:setvalue ref="xxforms:instance('get-STRUCTMAP-parameters')/dsID" value="string('STRUCTMAP')"/>
        <xforms:setvalue ref="xxforms:instance('get-STRUCTMAP-parameters')/destination-name" value="string('STRUCTMAP')"/>
        -->
        <!-- 
        <xforms:dispatch name="get-STRUCTMAP" 
                         target="CollectionModel-model" 
                         xxforms:show-progress="true"
                         xxforms:progress-message="Getting STRUCTMAP..."
                         />
        -->
        
        <xforms:load resource="{concat('/VuDL/object/', xxforms:instance('purgeTree-parameters')/parentPID)}"/>
        
        <!-- End Processing 
        <xforms:setvalue ref="xxforms:instance('purgeTree-parameters')/PID" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('purgeTree-parameters')/parentPID" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('purgeTree-parameters')/processing" value="string('false')"/>
        <xforms:setvalue ref="xxforms:instance('purgeTree-parameters')/total-objects" value="string('false')"/>
        <xforms:setvalue ref="xxforms:instance('purgeTree-parameters')/current-object" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('purgeTree-parameters')/current" value="string('0')"/>
        <xforms:setvalue ref="xxforms:instance('purgeTree-parameters')/file_position" value="string('0')"/>
        <xforms:setvalue ref="xxforms:instance('purgeTree-parameters')/total" value="string('0')"/>
        
        <xforms:delete nodeset="xxforms:instance('purgeTree-parameters')/children/*"/>
        -->
        <!-- 
        <xxforms:hide dialog="purge-progress-dialog"/>
        -->
    </xforms:action>
    

    <xforms:action ev:event="prepModifyObjectTree">

        <!-- Prepare Query -->
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/PID" value="xxforms:instance('modifyObject-editor')/PID"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/destination-instance" value="string('all-children-temp-raw')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/clear-destination-instance" value="string('true')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/flush" value="string('false')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/lang" value="string('itql')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/format" value="string('Sparql')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/limit" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/distinct" value="string('off')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/stream" value="string('off')"/>
        <xforms:setvalue ref="xxforms:instance('risearchQuery-parameters')/parameters/query" value="replace(xxforms:instance('getAllChildren-query'), 'XXX:XXX', xxforms:instance('risearchQuery-parameters')/PID)"/>
        <!-- -->
        <xforms:dispatch name="risearchQuery-prep-query" target="FedoraAPI-helper"/>
        <!-- -->
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/risearch?asOfDataTime=', now())"/>
            <xxforms:context name="dsID" value="string('')"/>
            <xxforms:context name="apiMethod" value="string('risearchQuery')"/>
            <xxforms:context name="httpMethod" value="string('post')"/>
            <xxforms:context name="mode" value="string('synchronous')"/>
            <xxforms:context name="destination-instance" value="xxforms:instance('risearchQuery-parameters')/destination-instance"/>
            <xxforms:context name="clear-destination-instance" value="xxforms:instance('risearchQuery-parameters')/clear-destination-instance"/>
        </xforms:dispatch>

        <!-- -->
        <xforms:insert nodeset="xxforms:instance('all-children-temp-formatted')"
                       origin="xxforms:call-xpl('oxf:/apps/VuDL/xpl/children.xpl', ('data','PID'), (xxforms:instance(xxforms:instance('risearchQuery-parameters')/destination-instance), xxforms:instance('risearchQuery-parameters')/PID), 'data')"/>
        
    </xforms:action>
    
    
    
    <xforms:action ev:event="modifyObjectTree">
        
        <!-- Start Processing -->
        <xforms:setvalue ref="xxforms:instance('modifyObjectTree-parameters')/processing" value="string('true')"/>

        <!-- -->
        <xxforms:show dialog="modifyObject-progress-dialog"/>
        
        <xforms:delete nodeset="xxforms:instance('modifyObjectTree-parameters')/children/*"/>
        
        <xforms:setvalue ref="xxforms:instance('modifyObjectTree-parameters')/total-objects" value="count(xxforms:instance('all-children-temp-formatted')//child)"/>
        <xforms:setvalue ref="xxforms:instance('modifyObjectTree-parameters')/total" value="count(xxforms:instance('all-children-temp-formatted')//child)"/>
        <xforms:setvalue ref="xxforms:instance('modifyObjectTree-parameters')/current" value="string('0')"/>
        <xforms:setvalue ref="xxforms:instance('modifyObjectTree-parameters')/file_position" value="string('0')"/>
        
        <!-- loop through and prepare //child's to modify -->
        <xforms:action xxforms:iterate="xxforms:instance('all-children-temp-formatted')//child">
            <xxforms:variable name="currentChild" value="."/>
            <xforms:insert context="xxforms:instance('modifyObjectTree-parameters')/children"
                           origin="xxforms:instance('modifyObjectTree-child')"
                           at="last()"
                           position="after"/>
            <xforms:setvalue ref="xxforms:instance('modifyObjectTree-parameters')/children/child[@uri='']/@name" value="$currentChild/@name"/>
            <xforms:setvalue ref="xxforms:instance('modifyObjectTree-parameters')/children/child[@uri='']/@numParents" value="$currentChild/@numParents"/>
            <xforms:setvalue ref="xxforms:instance('modifyObjectTree-parameters')/children/child[@uri='']/@uri" value="$currentChild/@uri"/>
            
            <xforms:delete nodeset="xxforms:instance('PIDmetadata')//object[@pid = substring-after($currentChild/@uri, '/')]"/>
            
        </xforms:action>
        
        <xforms:setvalue ref="xxforms:instance('modifyObjectTree-parameters')/processing" value="string('false')"/>
        
        <xforms:dispatch name="modifyObject-dispatch" 
                         target="CoreModel-helper" 
                         delay="1"/>

        <!-- -->
        <xxforms:hide dialog="modifyObject-count-dialog"/>
        
    </xforms:action>
    

    <!-- -->
    <xforms:action ev:event="modifyObject-dispatch">
        <xxforms:variable name="childPID" value="substring-after(xxforms:instance('modifyObjectTree-parameters')/children/child[xxforms:instance('modifyObjectTree-parameters')/file_position + 1]/@uri, 'info:fedora/')"/>

        <!-- Both selected -->
        <xforms:action if=".[xxforms:instance('modifyObject-editor')/state_children = 'Yes' and xxforms:instance('modifyObject-editor')/owner_children = 'Yes']"
                       
                       >
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/PID" value="$childPID"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/label" value="string('')"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/ownerId" value="xxforms:instance('modifyObject-editor')/owner"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/state" value="xxforms:instance('modifyObject-editor')/state"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/logMessage" value="string('Alter publish status and/or owner')"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/lastModifiedDate" value="now()"/>
            <xforms:dispatch name="performAPIRequest" 
                             target="FedoraAPI-helper"
                             xxforms:show-progress="true">
                <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('modifyObject-parameters')/PID)"/>
                <xxforms:context name="dsID" value="string('')"/>
                <xxforms:context name="apiMethod" value="string('modifyObject')"/>
                <xxforms:context name="httpMethod" value="string('put')"/>
                <xxforms:context name="mode" value="string('')"/>
                <xxforms:context name="destination-instance" value="string('')"/>
                <xxforms:context name="clear-destination-instance" value="string('')"/>
                <xxforms:context name="post-content" value="string('')"/>
                <xxforms:context name="parameters" value="string('modifyObject-parameters')"/>
            </xforms:dispatch>

        </xforms:action>
        
        
        <!-- Apply State to Children if necessary -->
        <xforms:action if=".[xxforms:instance('modifyObject-editor')/state_children = 'Yes' and xxforms:instance('modifyObject-editor')/owner_children != 'Yes']"
                       
                       >
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/PID" value="$childPID"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/label" value="string('')"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/ownerId" value="string('')"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/state" value="xxforms:instance('modifyObject-editor')/state"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/logMessage" value="string('Alter publish status and/or owner')"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/lastModifiedDate" value="now()"/>
            <xforms:dispatch name="performAPIRequest" 
                             target="FedoraAPI-helper"
                             xxforms:show-progress="true">
                <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('modifyObject-parameters')/PID)"/>
                <xxforms:context name="dsID" value="string('')"/>
                <xxforms:context name="apiMethod" value="string('modifyObject')"/>
                <xxforms:context name="httpMethod" value="string('put')"/>
                <xxforms:context name="mode" value="string('')"/>
                <xxforms:context name="destination-instance" value="string('')"/>
                <xxforms:context name="clear-destination-instance" value="string('')"/>
                <xxforms:context name="post-content" value="string('')"/>
                <xxforms:context name="parameters" value="string('modifyObject-parameters')"/>
            </xforms:dispatch>
            
        </xforms:action>
        
        
        <!-- Apply Owner to Children if necessary -->
        <xforms:action if=".[xxforms:instance('modifyObject-editor')/owner_children = 'Yes' and xxforms:instance('modifyObject-editor')/state_children != 'Yes']">
            <!-- -->
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/PID" value="$childPID"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/label" value="string('')"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/ownerId" value="xxforms:instance('modifyObject-editor')/owner"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/state" value="string('')"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/logMessage" value="string('Alter publish status and/or owner')"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/lastModifiedDate" value="now()"/>
            <xforms:dispatch name="performAPIRequest" 
                             target="FedoraAPI-helper"
                             xxforms:show-progress="true">
                <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('modifyObject-parameters')/PID)"/>
                <xxforms:context name="dsID" value="string('')"/>
                <xxforms:context name="apiMethod" value="string('modifyObject')"/>
                <xxforms:context name="httpMethod" value="string('put')"/>
                <xxforms:context name="mode" value="string('')"/>
                <xxforms:context name="destination-instance" value="string('')"/>
                <xxforms:context name="clear-destination-instance" value="string('')"/>
                <xxforms:context name="post-content" value="string('')"/>
                <xxforms:context name="parameters" value="string('modifyObject-parameters')"/>
            </xforms:dispatch>
            
        </xforms:action>

        <xforms:dispatch name="modifyObject-iteration" target="CoreModel-helper"/>
        
    </xforms:action>
    
    
    <!-- -->
    <xforms:action ev:event="modifyObject-iteration">
        <xforms:setvalue ref="xxforms:instance('modifyObjectTree-parameters')/current" value="xxforms:instance('modifyObjectTree-parameters')/current + 1"/>
        <xforms:setvalue ref="xxforms:instance('modifyObjectTree-parameters')/file_position" value="xxforms:instance('modifyObjectTree-parameters')/file_position + 1"/>
        
        <xforms:action if="number(xxforms:instance('modifyObjectTree-parameters')/file_position) ge number(xxforms:instance('modifyObjectTree-parameters')/total)">
            <xforms:dispatch name="modifyObject-dispatch-end"  
                             target="CoreModel-helper"/>
        </xforms:action>
        
        <xforms:action if="number(xxforms:instance('modifyObjectTree-parameters')/file_position) lt number(xxforms:instance('modifyObjectTree-parameters')/total)">
            <xforms:dispatch name="modifyObject-dispatch" 
                             delay="1" 
                             target="CoreModel-helper"/>
        </xforms:action> 
    </xforms:action>
    
    <!-- -->
    <xforms:action ev:event="modifyObject-dispatch-end">

        <!-- refresh member-tables if necessary -->
        <xforms:action if="xxforms:instance('MEMBER-TABLE-dialog-open') = 'MEMBER-LIST-RAW'">
            <xforms:dispatch name="load-dialog-MEMBER-LIST-RAW"
                             target="CoreModel-helper"
                             delay="1"
                             />
        </xforms:action>
        <xforms:action if="xxforms:instance('MEMBER-TABLE-dialog-open') = 'STRUCTMAP'">
            <xforms:dispatch name="load-dialog-STRUCTMAP"
                             target="CoreModel-helper"
                             delay="1"
                             />
        </xforms:action>
        
        <!-- re-open browse -->
        <xforms:setvalue ref="xxforms:instance('browse-members-parameters')/vudl:PID" value="xxforms:instance('modifyObject-editor')/PID"/>
        <xforms:setvalue ref="xxforms:instance('browse-members-parameters')/vudl:relationship" value="string('isMemberOf')"/>
        
        <xforms:dispatch name="browse-members" target="CoreModel-helper">
            <xxforms:context name="browse-members-target" select="string('browse-members')"/>
        </xforms:dispatch>
        
        <!-- Close Dialog -->
        <xxforms:hide dialog="modifyObject-progress-dialog"/>
        
    </xforms:action>
    
    
    
    <!-- get DC metadata for each isMemberOf in RELS-EXT -->
    <!-- xxforms:instance('RELS-EXT-metadata') -->
    <!-- TODO: Depricated 
    <xforms:action ev:event="get-RELS-EXT-metadata">


        <xxforms:variable name="source-instance" value="event('source-instance')"/>
        <xxforms:variable name="destination-name" value="event('destination-name')"/>
        <xxforms:variable name="clear-destination-instance" value="event('clear-destination-instance')"/>
        

        <xforms:delete nodeset="xxforms:instance($destination-name)/*"/>


        <xforms:action xxforms:iterate="xxforms:instance($source-instance)//rel:isMemberOf">
            <xxforms:variable name="memberPID" select="substring-after(./@rdf:resource, 'info:fedora/')"/>

            <xforms:dispatch name="performAPIRequest" 
                             target="FedoraAPI-helper"
                             xxforms:show-progress="true">
                <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', $memberPID, '/datastreams/', string('DC'), '/content?format=', string('xml'), '&amp;asOfDateTime=', now(),'&amp;validateChecksum=', string('false'))"/>
                <xxforms:context name="dsID" value="string('DC')"/>
                <xxforms:context name="apiMethod" value="string('getDatastreamDissemination')"/>
                <xxforms:context name="httpMethod" value="string('get')"/>
                <xxforms:context name="mode" value="string('synchronous')"/>
                <xxforms:context name="destination-instance" value="string('DC-temp-instance')"/>
                <xxforms:context name="clear-destination-instance" value="string('true')"/>
            </xforms:dispatch>


            <xforms:insert context="xxforms:instance($destination-name)"
                           origin="xxforms:instance('DC-temp-instance')"
                           at="last()"
                           position="after"
                           />
        </xforms:action>
    </xforms:action>
    -->
    
    <!-- get PARENT-LIST-RAW metadata for each isMemberOf in RELS-EXT -->
    <!-- xxforms:instance('RELS-EXT-PARENT-LIST-RAW') -->
    <!-- TODO: refactor this to use context parameters for dest-location and PID -->
    <xforms:action ev:event="get-RELS-EXT-PARENT-LIST-RAW">

        <!-- -->
        <xxforms:variable name="source-instance" value="event('source-instance')"/>
        <xxforms:variable name="destination-name" value="event('destination-name')"/>
        <xxforms:variable name="clear-destination-instance" value="event('clear-destination-instance')"/>
        
        <!-- -->
        <xforms:delete nodeset="xxforms:instance($destination-name)/*"/>

        <!-- -->
        <xforms:action xxforms:iterate="xxforms:instance($source-instance)//rel:isMemberOf">
            <xxforms:variable name="memberPID" select="substring-after(./@rdf:resource, 'info:fedora/')"/>
            <!-- Get PARENT-LIST-RAW content -->
            <!-- PARENT-LIST-RAW: getDatastreamDissemination -->
            <!-- xxforms:instance('PARENT-LIST-RAW-temp-instance') -->
            <xforms:dispatch name="performAPIRequest" 
                             target="FedoraAPI-helper"
                             xxforms:show-progress="true">
                <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', $memberPID, '/datastreams/', string('PARENT-LIST-RAW'), '/content?format=', string('xml'), '&amp;asOfDateTime=', now(),'&amp;validateChecksum=', string('false'))"/>
                <xxforms:context name="dsID" value="string('PARENT-LIST-RAW')"/>
                <xxforms:context name="apiMethod" value="string('getDatastreamDissemination')"/>
                <xxforms:context name="httpMethod" value="string('get')"/>
                <xxforms:context name="mode" value="string('synchronous')"/>
                <xxforms:context name="destination-instance" value="string('PARENT-LIST-RAW-temp-instance')"/>
                <xxforms:context name="clear-destination-instance" value="string('true')"/>
            </xforms:dispatch>

            <!-- this is needed for the call-xpl function. The value of param 3 must be a node, not string -->
            <xforms:setvalue ref="xxforms:instance('tempPID')/root()/tempPID" value="$memberPID"/>
            
            <!-- -->
            <xforms:insert context="xxforms:instance($destination-name)"
                           origin="xxforms:call-xpl('oxf:/apps/VuDL/xpl/parents.xpl', ('data','PID'), (xxforms:instance('PARENT-LIST-RAW-temp-instance'), xxforms:instance('tempPID')), 'data')"
                           at="last()"
                           position="after"
                           />
                  
            <!-- 
            <xforms:insert context="xxforms:instance($destination-name)"
                           origin="xxforms:instance('PARENT-LIST-RAW-temp-instance')"
                           at="last()"
                           position="after"
                           />
            -->
        </xforms:action>
    </xforms:action>
    
    <!-- -->
    <xforms:action ev:event="do-edit-RELS-EXT">
        <!-- compare changes to isMemberOf -->
        <!-- if deleted, remove from that PID's STRUCTMAP -->
        <!-- if added, add to that PID's STRUCTMAP -->
        <!-- modifyDatastream for PID with RELS-EXT-dialog-instance data -->
        
        <!-- loop through new additions -->
        <xforms:action xxforms:iterate="xxforms:instance('RELS-EXT-dialog-instance')//rel:isMemberOf">
            <xforms:action if="not(context()[@rdf:resource = xxforms:instance('RELS-EXT-dialog-temp-instance')//rel:isMemberOf/@rdf:resource])">
                <xxforms:variable name="newParentPID" value="substring-after(context()/@rdf:resource, 'info:fedora/')"/>
                <xxforms:variable name="newParentURI" value="context()/@rdf:resource"/>

                <!-- If parent has a STRUCTMAP -->
                <xforms:action if="xxforms:instance('PIDmetadata')/object[@pid = $newParentPID]/access:objectDatastreams/access:datastream[@dsid = 'STRUCTMAP']">

                    <!-- @@@ Add to Struct Map -->
                    <!-- Get STRUCTMAP content -->
                    <!-- Get STRUCTMAP -->
                    <!-- ~~~~~~~~~~~~~~~~ -->
                    <!-- STRUCTMAP: getDatastream -->
                    <!-- xxforms:instance('STRUCTMAP-temp-datastream-instance') -->
                    <xforms:dispatch name="performAPIRequest" 
                                     target="FedoraAPI-helper"
                                     xxforms:show-progress="true">
                        <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', $newParentPID, '/datastreams/', string('STRUCTMAP'), '?format=', string('xml'), '&amp;asOfDateTime=', now(),'&amp;validateChecksum=', string('false'))"/>
                        <xxforms:context name="dsID" value="string('STRUCTMAP')"/>
                        <xxforms:context name="apiMethod" value="string('getDatastream')"/>
                        <xxforms:context name="httpMethod" value="string('get')"/>
                        <xxforms:context name="mode" value="string('synchronous')"/>
                        <xxforms:context name="destination-instance" value="string('STRUCTMAP-temp-datastream-instance')"/>
                        <xxforms:context name="clear-destination-instance" value="string('true')"/>
                    </xforms:dispatch>
                    
                    <!-- STRUCTMAP: getDatastreamDissemination -->
                    <!-- xxforms:instance('STRUCTMAP-temp-instance') -->
                    <xforms:dispatch name="performAPIRequest" 
                                     target="FedoraAPI-helper"
                                     xxforms:show-progress="true">
                        <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', $newParentPID, '/datastreams/', string('STRUCTMAP'), '/content?format=', string('xml'), '&amp;asOfDateTime=', now(),'&amp;validateChecksum=', string('false'))"/>
                        <xxforms:context name="dsID" value="string('STRUCTMAP')"/>
                        <xxforms:context name="apiMethod" value="string('getDatastreamDissemination')"/>
                        <xxforms:context name="httpMethod" value="string('get')"/>
                        <xxforms:context name="mode" value="string('synchronous')"/>
                        <xxforms:context name="destination-instance" value="string('STRUCTMAP-temp-instance')"/>
                        <xxforms:context name="clear-destination-instance" value="string('true')"/>
                    </xforms:dispatch>
                    <!-- ~~~~~~~~~~~~~~~~ -->
    
                    <!-- insert line into new parents structmap -->
                    <xxforms:variable name="RELS-EXT-position" value="xxforms:instance('edit-RELS-EXT-item-position')//PID[. = $newParentPID]/parent::*/position"/>
                    <xxforms:variable name="RELS-EXT-at" value="xxforms:instance('edit-RELS-EXT-item-position')//PID[. = $newParentPID]/parent::*/at"/>
    
                    <!-- at="last" -->
                    <xforms:action if="$RELS-EXT-position = 'last'">
                        <xforms:insert context="xxforms:instance('STRUCTMAP-temp-instance')/root()/instance/METS:structMap"
                                       nodeset="METS:div"
                                       origin="xxforms:instance('STRUCTMAP-div-template')"
                                       at="last()"
                                       position="after"
                                       />
                        
                    </xforms:action>
                    <!-- at="first" -->
                    <xforms:action if="$RELS-EXT-position = 'first'">
                        <xforms:insert context="xxforms:instance('STRUCTMAP-temp-instance')/root()/instance/METS:structMap"
                                       nodeset="METS:div"
                                       origin="xxforms:instance('STRUCTMAP-div-template')"
                                       at="1"
                                       position="before"
                                       />
                    </xforms:action>
                    <!-- at="at" -->
                    <xforms:action if="$RELS-EXT-position = 'at'">
                        <xforms:insert context="xxforms:instance('STRUCTMAP-temp-instance')/root()/instance/METS:structMap"
                                       nodeset="METS:div"
                                       origin="xxforms:instance('STRUCTMAP-div-template')"
                                       at="$RELS-EXT-at"
                                       position="before"
                                       />
                    </xforms:action>
                    
                    <xforms:setvalue ref="xxforms:instance('STRUCTMAP-temp-instance')//METS:div/METS:fptr[@FILEID='']/@FILEID" value="xxforms:instance('edit-RELS-EXT-parameters')/PID"/>
                    
                    <!-- update/touch siblings affected by adding self into their STRUCTMAP - so they get updated in Solr -->
                    <xforms:action xxforms:iterate="xxforms:instance('STRUCTMAP-temp-instance')//METS:div/METS:fptr[@FILEID = xxforms:instance('edit-RELS-EXT-parameters')/PID]/../following-sibling::*">
                        <xxforms:variable name="refreshPid" value="./METS:fptr/@FILEID"/>
                        <xforms:action if="$refreshPid">
                            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/PID" value="$refreshPid"/>
                            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/label" value="string('')"/>
                            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/ownerId" value="string('')"/>
                            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/state" value="string('')"/>
                            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/logMessage" value="string('Position in parent STRUCTMAP as changed')"/>
                            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/lastModifiedDate" value="now()"/>
                            <!-- modifyObject -->
                            <xforms:dispatch name="performAPIRequest" 
                                             target="FedoraAPI-helper"
                                             xxforms:show-progress="true">
                                <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('modifyObject-parameters')/PID)"/>
                                <xxforms:context name="apiMethod" value="string('modifyObject')"/>
                                <xxforms:context name="httpMethod" value="string('put')"/>
                                <xxforms:context name="mode" value="string('')"/>
                                <xxforms:context name="destination-instance" value="string('')"/>
                                <xxforms:context name="clear-destination-instance" value="string('')"/>
                                <xxforms:context name="post-content" value="string('')"/>
                                <xxforms:context name="parameters" value="string('modifyObject-parameters')"/>
                            </xforms:dispatch>
                        </xforms:action>
                    </xforms:action>
                    
                    <!-- Save/Modify new Parents Structmap datastream -->
                    <!-- populate these params with data from the datastream -->
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/PID" value="$newParentPID"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/dsID" value="string('STRUCTMAP')"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsLocation" value="string('')"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/altIDs" value="string('')"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsLabel" value="xxforms:instance('STRUCTMAP-temp-datastream-instance')//management:dsLabel"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/versionable" value="xxforms:instance('STRUCTMAP-temp-datastream-instance')//management:dsVersionable"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsState" value="xxforms:instance('STRUCTMAP-temp-datastream-instance')//management:dsState"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/formatURI" value="xxforms:instance('STRUCTMAP-temp-datastream-instance')//management:dsFormatURI"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/checksumType" value="xxforms:instance('STRUCTMAP-temp-datastream-instance')//management:dsChecksumType"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/checksum" value="xxforms:instance('STRUCTMAP-temp-datastream-instance')//management:dsChecksum"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/mimeType" value="xxforms:instance('STRUCTMAP-temp-datastream-instance')//management:dsMIME"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/logMessage" value="string('Modified STRUCTMAP Datastream')"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/ignoreContent" value="string('false')"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/lastModifiedDate" value="now()"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/post-content" value="string('STRUCTMAP-temp-instance')"/>
                    <!-- <xforms:send submission="modifyDatastream" model="RestAPIModel-model"/> -->
                    <xforms:dispatch name="performAPIRequest" 
                                     target="FedoraAPI-helper"
                                     xxforms:show-progress="true">
                        <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('modifyDatastream-parameters')/PID, '/datastreams/', xxforms:instance('modifyDatastream-parameters')/dsID)"/>
                        <xxforms:context name="dsID" value="xxforms:instance('modifyDatastream-parameters')/dsID"/>
                        <xxforms:context name="apiMethod" value="string('modifyDatastream')"/>
                        <xxforms:context name="httpMethod" value="string('put')"/>
                        <xxforms:context name="mode" value="string('')"/>
                        <xxforms:context name="destination-instance" value="string('')"/>
                        <xxforms:context name="clear-destination-instance" value="string('')"/>
                        <xxforms:context name="post-content" value="xxforms:instance('modifyDatastream-parameters')/post-content"/>
                        <xxforms:context name="parameters" value="string('modifyDatastream-parameters')"/>
                    </xforms:dispatch>
                    
                </xforms:action>
                
                <!-- Add Relationship -->
                <!--
                {xxforms:instance('config-instance')/fedora/APIurl}:{xxforms:instance('config-instance')/fedora/APIport}/fedora/objects/{xxforms:instance('addRelationship-parameters')/PID}/relationships/new?subject={encode-for-uri(xxforms:instance('addRelationship-parameters')/parameters/subject)}&amp;predicate={encode-for-uri(xxforms:instance('addRelationship-parameters')/parameters/predicate)}&amp;object={encode-for-uri(xxforms:instance('addRelationship-parameters')/parameters/object)}&amp;isLiteral={xxforms:instance('addRelationship-parameters')/parameters/isLiteral}&amp;datatype={xxforms:instance('addRelationship-parameters')/parameters/datatype}
                -->
                <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/PID" value="xxforms:instance('edit-RELS-EXT-parameters')/PID"/>
                <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/parameters/subject" value="encode-for-uri(concat('info:fedora/', xxforms:instance('edit-RELS-EXT-parameters')/PID))"/>
                <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/parameters/predicate" value="encode-for-uri(string('info:fedora/fedora-system:def/relations-external#isMemberOf'))"/>
                <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/parameters/object" value="encode-for-uri($newParentURI)"/>
                <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/parameters/isLiteral" value="string('false')"/>
                <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/parameters/datatype" value="string('')"/>
                <xforms:dispatch name="performAPIRequest" 
                                 target="FedoraAPI-helper"
                                 xxforms:show-progress="true">
                    <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('addRelationship-parameters')/PID, '/relationships/new')"/>
                    <xxforms:context name="dsID" value="string('')"/>
                    <xxforms:context name="apiMethod" value="string('addRelationship')"/>
                    <xxforms:context name="httpMethod" value="string('post')"/>
                    <xxforms:context name="mode" value="string('')"/>
                    <xxforms:context name="destination-instance" value="string('')"/>
                    <xxforms:context name="clear-destination-instance" value="string('')"/>
                    <xxforms:context name="parameters" value="string('addRelationship-parameters')"/>
                </xforms:dispatch>

                <!-- update browse (if its open)  -->
                <xforms:action if="xxforms:instance('browse-members-instance')//sparql:sparql[@PID = $newParentPID]">
                    <!-- delete parents's sparql result -->
                    <xforms:delete nodeset="xxforms:instance('browse-members-instance')//sparql:sparql[@PID = $newParentPID]"/>
                    
                    <!-- reinit parent -->
                    <xforms:setvalue ref="xxforms:instance('browse-members-parameters')/vudl:PID" value="$newParentPID"/>
                    <xforms:setvalue ref="xxforms:instance('browse-members-parameters')/vudl:relationship" value="string('isMemberOf')"/>
                    <!-- -->
                    <xforms:dispatch name="browse-members" target="CoreModel-helper">
                        <xxforms:context name="browse-members-target" select="string('browse-members')"/>
                    </xforms:dispatch>
                </xforms:action>

            </xforms:action>
        </xforms:action>
        
        <!-- loop through deletions -->
        <xforms:action xxforms:iterate="xxforms:instance('RELS-EXT-dialog-temp-instance')//rel:isMemberOf">
            <xforms:action if="not(context()[@rdf:resource = xxforms:instance('RELS-EXT-dialog-instance')//rel:isMemberOf/@rdf:resource])">
                <xxforms:variable name="deleteParentPID" value="substring-after(context()/@rdf:resource, 'info:fedora/')"/>
                <xxforms:variable name="deleteParentURI" value="context()/@rdf:resource"/>

                <!-- -->
                <!-- update parent ResourceCollection if one exists -->
                <xforms:dispatch name="update-parent-resource"
                                 target="CoreModel-helper">
                    <xxforms:context name="PID" value="xxforms:instance('edit-RELS-EXT-parameters')/PID"/>
                </xforms:dispatch>
                
                <!-- if STRUCTMAP -->
                <xforms:action if="xxforms:instance('PIDmetadata')/object[@pid = $deleteParentPID]/access:objectDatastreams/access:datastream[@dsid = 'STRUCTMAP']">

                    <!-- @@@ Remove from Struct Map -->
                    <!-- Get STRUCTMAP content -->
                    <!-- xxforms:instance('STRUCTMAP-temp-instance') -->
                    <!-- xxforms:instance('STRUCTMAP-temp-datastream-instance') -->
                    <!-- ~~~~~~~~~~~~~~~~ -->
                    <!-- STRUCTMAP: getDatastream -->
                    <!-- xxforms:instance('STRUCTMAP-temp-datastream-instance') -->
                    <xforms:dispatch name="performAPIRequest" 
                                     target="FedoraAPI-helper"
                                     xxforms:show-progress="true">
                        <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', $deleteParentPID, '/datastreams/', string('STRUCTMAP'), '?format=', string('xml'), '&amp;asOfDateTime=', now(),'&amp;validateChecksum=', string('false'))"/>
                        <xxforms:context name="dsID" value="string('STRUCTMAP')"/>
                        <xxforms:context name="apiMethod" value="string('getDatastream')"/>
                        <xxforms:context name="httpMethod" value="string('get')"/>
                        <xxforms:context name="mode" value="string('synchronous')"/>
                        <xxforms:context name="destination-instance" value="string('STRUCTMAP-temp-datastream-instance')"/>
                        <xxforms:context name="clear-destination-instance" value="string('true')"/>
                    </xforms:dispatch>
                    <!-- STRUCTMAP: getDatastreamDissemination -->
                    <!-- xxforms:instance('STRUCTMAP-temp-instance') -->
                    <xforms:dispatch name="performAPIRequest" 
                                     target="FedoraAPI-helper"
                                     xxforms:show-progress="true">
                        <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', $deleteParentPID, '/datastreams/', string('STRUCTMAP'), '/content?format=', string('xml'), '&amp;asOfDateTime=', now(),'&amp;validateChecksum=', string('false'))"/>
                        <xxforms:context name="dsID" value="string('STRUCTMAP')"/>
                        <xxforms:context name="apiMethod" value="string('getDatastreamDissemination')"/>
                        <xxforms:context name="httpMethod" value="string('get')"/>
                        <xxforms:context name="mode" value="string('synchronous')"/>
                        <xxforms:context name="destination-instance" value="string('STRUCTMAP-temp-instance')"/>
                        <xxforms:context name="clear-destination-instance" value="string('true')"/>
                    </xforms:dispatch>
                    <!-- ~~~~~~~~~~~~~~~~ -->
                    
                    <!-- update/touch siblings affected by adding self into their STRUCTMAP - so they get updated in Solr -->
                    <xforms:action xxforms:iterate="xxforms:instance('STRUCTMAP-temp-instance')//METS:div/METS:fptr[@FILEID = xxforms:instance('edit-RELS-EXT-parameters')/PID]/../following-sibling::*">
                        <xxforms:variable name="refreshPid" value="./METS:fptr/@FILEID"/>

                        <xforms:action if="$refreshPid">

                            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/PID" value="$refreshPid"/>
                            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/label" value="string('')"/>
                            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/ownerId" value="string('')"/>
                            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/state" value="string('')"/>
                            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/logMessage" value="string('Position in parent STRUCTMAP as changed')"/>
                            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/lastModifiedDate" value="now()"/>
                            <!-- modifyObject -->
                            <xforms:dispatch name="performAPIRequest" 
                                             target="FedoraAPI-helper"
                                             xxforms:show-progress="true">
                                <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('modifyObject-parameters')/PID)"/>
                                <xxforms:context name="apiMethod" value="string('modifyObject')"/>
                                <xxforms:context name="httpMethod" value="string('put')"/>
                                <xxforms:context name="mode" value="string('')"/>
                                <xxforms:context name="destination-instance" value="string('')"/>
                                <xxforms:context name="clear-destination-instance" value="string('')"/>
                                <xxforms:context name="post-content" value="string('')"/>
                                <xxforms:context name="parameters" value="string('modifyObject-parameters')"/>
                            </xforms:dispatch>
                        </xforms:action>
                    </xforms:action>
                    
                    <!-- remove node -->
                    <xforms:delete nodeset="xxforms:instance('STRUCTMAP-temp-instance')//METS:fptr[@FILEID = xxforms:instance('edit-RELS-EXT-parameters')/PID]/parent::*"/>
                    
                    
                    <!-- Push updated structmap -->
                    <!-- populate these params with data from the datastream -->
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/PID" value="$deleteParentPID"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/dsID" value="string('STRUCTMAP')"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsLocation" value="string('')"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/altIDs" value="string('')"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsLabel" value="xxforms:instance('STRUCTMAP-temp-datastream-instance')//management:dsLabel"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/versionable" value="xxforms:instance('STRUCTMAP-temp-datastream-instance')//management:dsVersionable"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsState" value="xxforms:instance('STRUCTMAP-temp-datastream-instance')//management:dsState"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/formatURI" value="xxforms:instance('STRUCTMAP-temp-datastream-instance')//management:dsFormatURI"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/checksumType" value="xxforms:instance('STRUCTMAP-temp-datastream-instance')//management:dsChecksumType"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/checksum" value="xxforms:instance('STRUCTMAP-temp-datastream-instance')//management:dsChecksum"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/mimeType" value="xxforms:instance('STRUCTMAP-temp-datastream-instance')//management:dsMIME"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/logMessage" value="string('Modified STRUCTMAP Datastream')"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/ignoreContent" value="string('false')"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/lastModifiedDate" value="now()"/>
                    <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/post-content" value="string('STRUCTMAP-temp-instance')"/>
                    <xforms:dispatch name="performAPIRequest" 
                                     target="FedoraAPI-helper"
                                     xxforms:show-progress="true">
                        <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('modifyDatastream-parameters')/PID, '/datastreams/', xxforms:instance('modifyDatastream-parameters')/dsID)"/>
                        <xxforms:context name="dsID" value="xxforms:instance('modifyDatastream-parameters')/dsID"/>
                        <xxforms:context name="apiMethod" value="string('modifyDatastream')"/>
                        <xxforms:context name="httpMethod" value="string('put')"/>
                        <xxforms:context name="mode" value="string('')"/>
                        <xxforms:context name="destination-instance" value="string('')"/>
                        <xxforms:context name="clear-destination-instance" value="string('')"/>
                        <xxforms:context name="post-content" value="xxforms:instance('modifyDatastream-parameters')/post-content"/>
                        <xxforms:context name="parameters" value="string('modifyDatastream-parameters')"/>
                    </xforms:dispatch>
                    
                </xforms:action>
                
                <!-- Remove Relationship -->
                <xforms:setvalue ref="xxforms:instance('purgeRelationship-parameters')/PID" value="xxforms:instance('edit-RELS-EXT-parameters')/PID"/>
                <xforms:setvalue ref="xxforms:instance('purgeRelationship-parameters')/parameters/subject" value="concat('info:fedora/', xxforms:instance('edit-RELS-EXT-parameters')/PID)"/>
                <xforms:setvalue ref="xxforms:instance('purgeRelationship-parameters')/parameters/predicate" value="string('info:fedora/fedora-system:def/relations-external#isMemberOf')"/>
                <xforms:setvalue ref="xxforms:instance('purgeRelationship-parameters')/parameters/object" value="$deleteParentURI"/>
                <xforms:setvalue ref="xxforms:instance('purgeRelationship-parameters')/parameters/isLiteral" value="string('false')"/>
                <xforms:setvalue ref="xxforms:instance('purgeRelationship-parameters')/parameters/datatype" value="string('')"/>
                <xforms:dispatch name="performAPIRequest" 
                                 target="FedoraAPI-helper"
                                 xxforms:show-progress="true">
                    <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('purgeRelationship-parameters')/PID, '/relationships')"/>
                    <xxforms:context name="dsID" value="string('')"/>
                    <xxforms:context name="apiMethod" value="string('purgeRelationship')"/>
                    <xxforms:context name="httpMethod" value="string('delete')"/>
                    <xxforms:context name="mode" value="string('')"/>
                    <xxforms:context name="destination-instance" value="string('')"/>
                    <xxforms:context name="clear-destination-instance" value="string('')"/>
                    <xxforms:context name="parameters" value="string('purgeRelationship-parameters')"/>
                </xforms:dispatch>
                <!--
                {xxforms:instance('config-instance')/fedora/APIurl}:{xxforms:instance('config-instance')/fedora/APIport}/fedora/objects/{xxforms:instance('purgeRelationship-parameters')/PID}/relationships?subject={encode-for-uri(xxforms:instance('purgeRelationship-parameters')/parameters/subject)}&amp;predicate={encode-for-uri(xxforms:instance('purgeRelationship-parameters')/parameters/predicate)}&amp;object={encode-for-uri(xxforms:instance('purgeRelationship-parameters')/parameters/object)}&amp;isLiteral={xxforms:instance('purgeRelationship-parameters')/parameters/isLiteral}&amp;datatype={xxforms:instance('purgeRelationship-parameters')/parameters/datatype}
                -->
                
                <!-- update browse (if its open)  -->
                <xforms:action if="xxforms:instance('browse-members-instance')//sparql:sparql[@PID = $deleteParentPID]">
                    <!-- delete parents's sparql result -->
                    <xforms:delete nodeset="xxforms:instance('browse-members-instance')//sparql:sparql[@PID = $deleteParentPID]"/>
                    
                    <!-- reinit parent -->
                    <xforms:setvalue ref="xxforms:instance('browse-members-parameters')/vudl:PID" value="$deleteParentPID"/>
                    <xforms:setvalue ref="xxforms:instance('browse-members-parameters')/vudl:relationship" value="string('isMemberOf')"/>
                    <!-- -->
                    <xforms:dispatch name="browse-members" target="CoreModel-helper">
                        <xxforms:context name="browse-members-target" select="string('browse-members')"/>
                    </xforms:dispatch>
                </xforms:action>

            </xforms:action>
            
        </xforms:action>

        <!-- remove isPartOf relationship if necessary -->
        <xforms:action xxforms:iterate="xxforms:instance('RELS-EXT-dialog-temp-instance')//rel:isPartOf">
            <xforms:action if="not(context()[@rdf:resource = xxforms:instance('RELS-EXT-dialog-instance')//rel:isPartOf/@rdf:resource])">
                
                <xxforms:variable name="deleteParentPID" value="substring-after(context()/@rdf:resource, 'info:fedora/')"/>
                <xxforms:variable name="deleteParentURI" value="context()/@rdf:resource"/>

                <!-- -->
                <!-- update parent ResourceCollection if one exists -->
                <xforms:dispatch name="update-parent-resource"
                                 target="CoreModel-helper">
                    <xxforms:context name="PID" value="xxforms:instance('edit-RELS-EXT-parameters')/PID"/>
                </xforms:dispatch>
                
                <!-- Remove Relationship -->
                <xforms:setvalue ref="xxforms:instance('purgeRelationship-parameters')/PID" value="xxforms:instance('edit-RELS-EXT-parameters')/PID"/>
                <xforms:setvalue ref="xxforms:instance('purgeRelationship-parameters')/parameters/subject" value="concat('info:fedora/', xxforms:instance('edit-RELS-EXT-parameters')/PID)"/>
                <xforms:setvalue ref="xxforms:instance('purgeRelationship-parameters')/parameters/predicate" value="string('info:fedora/fedora-system:def/relations-external#isPartOf')"/>
                <xforms:setvalue ref="xxforms:instance('purgeRelationship-parameters')/parameters/object" value="$deleteParentURI"/>
                <xforms:setvalue ref="xxforms:instance('purgeRelationship-parameters')/parameters/isLiteral" value="string('false')"/>
                <xforms:setvalue ref="xxforms:instance('purgeRelationship-parameters')/parameters/datatype" value="string('')"/>
                <xforms:dispatch name="performAPIRequest" 
                                 target="FedoraAPI-helper"
                                 xxforms:show-progress="true">
                    <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('purgeRelationship-parameters')/PID, '/relationships')"/>
                    <xxforms:context name="dsID" value="string('')"/>
                    <xxforms:context name="apiMethod" value="string('purgeRelationship')"/>
                    <xxforms:context name="httpMethod" value="string('delete')"/>
                    <xxforms:context name="mode" value="string('')"/>
                    <xxforms:context name="destination-instance" value="string('')"/>
                    <xxforms:context name="clear-destination-instance" value="string('')"/>
                    <xxforms:context name="parameters" value="string('purgeRelationship-parameters')"/>
                </xforms:dispatch>
                
            </xforms:action>
        </xforms:action>
        
        <!-- hasModel -->
        
        
        <xforms:action if="string-length(xxforms:instance('edit-RELS-EXT-parameters')/ModelType)">
            
            <!-- purge Old hasModels -->
            <xforms:action xxforms:iterate="xxforms:instance('RELS-EXT-dialog-temp-instance')//fedora-model:hasModel">
                <xxforms:variable name="uri" select="./@rdf:resource"/>
                <!-- Purge Relationship - hasModel -->
                <xforms:setvalue ref="xxforms:instance('purgeRelationship-parameters')/PID" value="xxforms:instance('edit-RELS-EXT-parameters')/PID"/>
                <xforms:setvalue ref="xxforms:instance('purgeRelationship-parameters')/parameters/subject" value="encode-for-uri(concat('info:fedora/', xxforms:instance('edit-RELS-EXT-parameters')/PID))"/>
                <xforms:setvalue ref="xxforms:instance('purgeRelationship-parameters')/parameters/predicate" value="encode-for-uri(string('info:fedora/fedora-system:def/model#hasModel'))"/>
                <xforms:setvalue ref="xxforms:instance('purgeRelationship-parameters')/parameters/object" value="encode-for-uri($uri)"/>
                <xforms:setvalue ref="xxforms:instance('purgeRelationship-parameters')/parameters/isLiteral" value="string('false')"/>
                <xforms:setvalue ref="xxforms:instance('purgeRelationship-parameters')/parameters/datatype" value="string('')"/>
                <xforms:dispatch name="performAPIRequest" 
                                 target="FedoraAPI-helper"
                                 xxforms:show-progress="true">
                    <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('purgeRelationship-parameters')/PID, '/relationships')"/>
                    <xxforms:context name="dsID" value="string('')"/>
                    <xxforms:context name="apiMethod" value="string('purgeRelationship')"/>
                    <xxforms:context name="httpMethod" value="string('delete')"/>
                    <xxforms:context name="mode" value="string('')"/>
                    <xxforms:context name="destination-instance" value="string('')"/>
                    <xxforms:context name="clear-destination-instance" value="string('')"/>
                    <xxforms:context name="parameters" value="string('purgeRelationship-parameters')"/>
                </xforms:dispatch>
                <!-- <xforms:send submission="purgeRelationship" model="RestAPIModel-model"/> -->
            </xforms:action>
            
            <!-- add New hasModels -->
            <xforms:action xxforms:iterate="xxforms:instance('ModelTypes')//ModelType[@fullname=xxforms:instance('edit-RELS-EXT-parameters')/ModelType]/ancestor-or-self::*">
                <xxforms:variable name="uri" select="./@uri"/>
                <!-- Add Relationship - hasModel -->
                <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/PID" value="xxforms:instance('edit-RELS-EXT-parameters')/PID"/>
                <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/parameters/subject" value="encode-for-uri(concat('info:fedora/', xxforms:instance('edit-RELS-EXT-parameters')/PID))"/>
                <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/parameters/predicate" value="encode-for-uri(string('info:fedora/fedora-system:def/model#hasModel'))"/>
                <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/parameters/object" value="encode-for-uri($uri)"/>
                <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/parameters/isLiteral" value="string('false')"/>
                <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/parameters/datatype" value="string('')"/>
                <xforms:dispatch name="performAPIRequest" 
                                 target="FedoraAPI-helper"
                                 xxforms:show-progress="true">
                    <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('addRelationship-parameters')/PID, '/relationships/new')"/>
                    <xxforms:context name="dsID" value="string('')"/>
                    <xxforms:context name="apiMethod" value="string('addRelationship')"/>
                    <xxforms:context name="httpMethod" value="string('post')"/>
                    <xxforms:context name="mode" value="string('')"/>
                    <xxforms:context name="destination-instance" value="string('')"/>
                    <xxforms:context name="clear-destination-instance" value="string('')"/>
                    <xxforms:context name="parameters" value="string('addRelationship-parameters')"/>
                </xforms:dispatch>

            </xforms:action>
            
        </xforms:action>
        
        <!-- update parent ResourceCollection if one exists -->
        <xforms:dispatch name="update-parent-resource"
                         target="CoreModel-helper">
            <xxforms:context name="PID" value="xxforms:instance('edit-RELS-EXT-parameters')/PID"/>
        </xforms:dispatch>
        
        <!-- update breadcrumb if we're working on currentPID -->
        <xforms:action if="xxforms:instance('edit-RELS-EXT-parameters')/PID = xxforms:instance('currentPID')">
            <!-- TODO: combine these asynchronously by creating a completion event that transforms the list into a breadcrumb -->
            <!-- PARENT-LIST-RAW: getDatastreamDissemination -->
            <!-- xxforms:instance('PARENT-LIST-RAW-Core-instance') -->
            <xforms:dispatch name="performAPIRequest" 
                             target="FedoraAPI-helper"
                             xxforms:show-progress="true">
                <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('currentPID'), '/datastreams/', string('PARENT-LIST-RAW'), '/content?format=', string('xml'), '&amp;asOfDateTime=', now(),'&amp;validateChecksum=', string('false'))"/>
                <xxforms:context name="dsID" value="string('PARENT-LIST-RAW')"/>
                <xxforms:context name="apiMethod" value="string('getDatastreamDissemination')"/>
                <xxforms:context name="httpMethod" value="string('get')"/>
                <xxforms:context name="mode" value="string('synchronous')"/>
                <xxforms:context name="destination-instance" value="string('PARENT-LIST-RAW-Core-instance')"/>
                <xxforms:context name="clear-destination-instance" value="string('true')"/>
            </xforms:dispatch>
            <!-- ~~~~~~~~~~~~~~~~ -->
            
            <!-- Breadcrumb Format Output -->
            <!-- TODO: Use this instead: http://wiki.orbeon.com/forms/how-to/logic/xslt-from-xforms -->
            <xforms:delete nodeset="xxforms:instance('breadcrumb')/*"/>
            <xforms:insert nodeset="xxforms:instance('breadcrumb')"
                           origin="xxforms:call-xpl('oxf:/apps/VuDL/xpl/breadcrumb.xpl', ('data','PID'), (xxforms:instance('PARENT-LIST-RAW-Core-instance'), xxforms:instance('currentPID')), 'data')"/>
        </xforms:action>
        
        <!-- refresh member-tables if necessary -->
        <xforms:action if="xxforms:instance('MEMBER-TABLE-dialog-open') = 'MEMBER-LIST-RAW'">
            <xforms:dispatch name="load-dialog-MEMBER-LIST-RAW"
                             target="CoreModel-helper"
                             delay="1"
                             />
        </xforms:action>
        <xforms:action if="xxforms:instance('MEMBER-TABLE-dialog-open') = 'STRUCTMAP'">
            <xforms:dispatch name="load-dialog-STRUCTMAP"
                             target="CoreModel-helper"
                             delay="1"
                             />
        </xforms:action>
        
    </xforms:action>
    

    <!-- ******************* -->
    <!-- BASE Ingest Process -->
    <!-- ******************* -->
    <xforms:action ev:event="object-ingest">
        <!-- -->
        <xxforms:variable name="objectType" value="xxforms:instance('object-ingest-parameters')/objectType"/>
        
        <!-- get Next PID -->
        <!-- TODO: these were corrupting other submissions after ingesting objects 
                    so I added them to the resource URL -->
        <!-- 
        <xforms:setvalue ref="xxforms:instance('getNextPID-parameters')/parameters/numPIDs" value="string('1')"/>
        <xforms:setvalue ref="xxforms:instance('getNextPID-parameters')/parameters/namespace" value="string('vudl')"/>
        <xforms:setvalue ref="xxforms:instance('getNextPID-parameters')/parameters/format" value="string('xml')"/>
        -->
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/nextPID?numPIDs=', string('1'), '&amp;namespace=', string('vudl'), '&amp;format=', string('xml'))"/>
            <xxforms:context name="PID" value="string('')"/>
            <xxforms:context name="dsID" value="string('')"/>
            <xxforms:context name="apiMethod" value="string('getNextPID')"/>
            <xxforms:context name="httpMethod" value="string('post')"/>
            <xxforms:context name="mode" value="string('synchronous')"/>
            <xxforms:context name="destination-instance" value="string('')"/>
            <xxforms:context name="clear-destination-instance" value="string('')"/>
            <xxforms:context name="parameters" value="string('')"/> <!-- getNextPID-parameters -->
        </xforms:dispatch>

        <!-- ingest blank foxml -->
        <xforms:setvalue ref="xxforms:instance('ingest-parameters')/PID" value="xxforms:instance('newPID')"/>
        <xforms:setvalue ref="xxforms:instance('ingest-parameters')/parameters/label" value="xxforms:instance('object-ingest-parameters')/title"/>
        <xforms:setvalue ref="xxforms:instance('ingest-parameters')/parameters/format" value="string('info:fedora/fedora-system:FOXML-1.1')"/>
        <xforms:setvalue ref="xxforms:instance('ingest-parameters')/parameters/encoding" value="string('UTF-8')"/>
        <xforms:setvalue ref="xxforms:instance('ingest-parameters')/parameters/namespace" value="string('vudl')"/>
        <xforms:setvalue ref="xxforms:instance('ingest-parameters')/parameters/ownerId" value="xxforms:instance('object-ingest-parameters')/owner"/>
        <xforms:setvalue ref="xxforms:instance('ingest-parameters')/parameters/logMessage" value="string('Initial Ingest')"/>
        <xforms:setvalue ref="xxforms:instance('ingest-parameters')/parameters/ignoreMime" value="string('false')"/>
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('ingest-parameters')/PID)"/>
            <xxforms:context name="PID" value="xxforms:instance('ingest-parameters')/PID"/>
            <xxforms:context name="dsID" value="string('')"/>
            <xxforms:context name="apiMethod" value="string('ingest')"/>
            <xxforms:context name="httpMethod" value="string('post')"/>
            <xxforms:context name="mode" value="string('synchronous')"/>
            <xxforms:context name="destination-instance" value="string('')"/>
            <xxforms:context name="clear-destination-instance" value="string('')"/>
            <xxforms:context name="parameters" value="string('ingest-parameters')"/>
        </xforms:dispatch>
        

        <!-- update state -->
        <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/PID" value="xxforms:instance('newPID')"/>
        <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/label" value="substring(xxforms:instance('object-ingest-parameters')/title, 1, 150)"/>
        <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/ownerId" value="xxforms:instance('object-ingest-parameters')/owner"/>
        <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/state" value="xxforms:instance('object-ingest-parameters')/state"/>
        <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/logMessage" value="string('Updating Object State after Ingest')"/>
        <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/lastModifiedDate" value="now()"/>
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('modifyObject-parameters')/PID)"/>
            <xxforms:context name="dsID" value="string('')"/>
            <xxforms:context name="apiMethod" value="string('modifyObject')"/>
            <xxforms:context name="httpMethod" value="string('put')"/>
            <xxforms:context name="mode" value="string('')"/>
            <xxforms:context name="destination-instance" value="string('')"/>
            <xxforms:context name="clear-destination-instance" value="string('')"/>
            <xxforms:context name="post-content" value="string('')"/>
            <xxforms:context name="parameters" value="string('modifyObject-parameters')"/>
        </xforms:dispatch>
        
            
        <!-- Loop through tree and dispatch "add" commands -->
        <xforms:action xxforms:iterate="xxforms:instance('object-ingest-parameters')/objectTypes/ModelType">
            <xxforms:variable name="ModelName" select="./@fullname"/>
            <xforms:dispatch name="{$ModelName}-ingest" target="{$ModelName}-helper"/>
        </xforms:action>
        
        <!-- Once the ingest is finished loop through the Models again and do some house cleaning -->
        <xforms:action xxforms:iterate="xxforms:instance('object-ingest-parameters')/objectTypes/ModelType">
            <xxforms:variable name="ModelName" select="./@fullname"/>
            <xforms:dispatch name="{$ModelName}-ingest-update" target="{$ModelName}-helper"/>
        </xforms:action>

    </xforms:action>

    <!-- **************** -->
    <!-- CoreModel Ingest -->
    <!-- **************** -->
    <xforms:action ev:event="CoreModel-ingest">

        <xforms:action xxforms:iterate="xxforms:instance('object-ingest-parameters')/objectTypes/ModelType">
            <xxforms:variable name="uri" select="./@uri"/>
            
            <!-- Add Relationship - hasModel -->
            <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/PID" value="xxforms:instance('newPID')"/>
            <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/parameters/subject" value="encode-for-uri(concat('info:fedora/', xxforms:instance('newPID')))"/>
            <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/parameters/predicate" value="encode-for-uri(string('info:fedora/fedora-system:def/model#hasModel'))"/>
            <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/parameters/object" value="encode-for-uri($uri)"/>
            <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/parameters/isLiteral" value="string('false')"/>
            <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/parameters/datatype" value="string('')"/>
            <xforms:dispatch name="performAPIRequest" 
                             target="FedoraAPI-helper"
                             xxforms:show-progress="true">
                <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('addRelationship-parameters')/PID, '/relationships/new')"/>
                <xxforms:context name="dsID" value="string('')"/>
                <xxforms:context name="apiMethod" value="string('addRelationship')"/>
                <xxforms:context name="httpMethod" value="string('post')"/>
                <xxforms:context name="mode" value="string('')"/>
                <xxforms:context name="destination-instance" value="string('')"/>
                <xxforms:context name="clear-destination-instance" value="string('')"/>
                <xxforms:context name="parameters" value="string('addRelationship-parameters')"/>
            </xforms:dispatch>

        </xforms:action>

        <!-- Add Relationship - isMemberOf Parent -->
        <xforms:action if="not(xxforms:instance('PIDmetadata')/object[@pid = xxforms:instance('object-ingest-parameters')/parentPID]//access:model[.='info:fedora/vudl-system:ImageData'])">
            <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/PID" value="xxforms:instance('newPID')"/>
            <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/parameters/subject" value="encode-for-uri(concat('info:fedora/', xxforms:instance('newPID')))"/>
            <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/parameters/predicate" value="encode-for-uri(string('info:fedora/fedora-system:def/relations-external#isMemberOf'))"/>
            <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/parameters/object" value="encode-for-uri(concat('info:fedora/', xxforms:instance('object-ingest-parameters')/parentPID))"/>
            <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/parameters/isLiteral" value="string('false')"/>
            <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/parameters/datatype" value="string('')"/>
            <xforms:dispatch name="performAPIRequest" 
                             target="FedoraAPI-helper"
                             xxforms:show-progress="true">
                <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('addRelationship-parameters')/PID, '/relationships/new')"/>
                <xxforms:context name="dsID" value="string('')"/>
                <xxforms:context name="apiMethod" value="string('addRelationship')"/>
                <xxforms:context name="httpMethod" value="string('post')"/>
                <xxforms:context name="mode" value="string('')"/>
                <xxforms:context name="destination-instance" value="string('')"/>
                <xxforms:context name="clear-destination-instance" value="string('')"/>
                <xxforms:context name="parameters" value="string('addRelationship-parameters')"/>
            </xforms:dispatch>
        </xforms:action>
        
        <!-- Add Relationship - isPartOf Parent -->
        <xforms:action if="xxforms:instance('PIDmetadata')/object[@pid = xxforms:instance('object-ingest-parameters')/parentPID]//access:model[.='info:fedora/vudl-system:ImageData']">
            <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/PID" value="xxforms:instance('newPID')"/>
            <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/parameters/subject" value="encode-for-uri(concat('info:fedora/', xxforms:instance('newPID')))"/>
            <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/parameters/predicate" value="encode-for-uri(string('info:fedora/fedora-system:def/relations-external#isPartOf'))"/>
            <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/parameters/object" value="encode-for-uri(concat('info:fedora/', xxforms:instance('object-ingest-parameters')/parentPID))"/>
            <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/parameters/isLiteral" value="string('false')"/>
            <xforms:setvalue ref="xxforms:instance('addRelationship-parameters')/parameters/datatype" value="string('')"/>
            <xforms:dispatch name="performAPIRequest" 
                             target="FedoraAPI-helper"
                             xxforms:show-progress="true">
                <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('addRelationship-parameters')/PID, '/relationships/new')"/>
                <xxforms:context name="dsID" value="string('')"/>
                <xxforms:context name="apiMethod" value="string('addRelationship')"/>
                <xxforms:context name="httpMethod" value="string('post')"/>
                <xxforms:context name="mode" value="string('')"/>
                <xxforms:context name="destination-instance" value="string('')"/>
                <xxforms:context name="clear-destination-instance" value="string('')"/>
                <xxforms:context name="parameters" value="string('addRelationship-parameters')"/>
            </xforms:dispatch>
        </xforms:action>
        

        <!-- Add THUMBNAIL -->
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/PID" value="xxforms:instance('newPID')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/dsID" value="string('THUMBNAIL')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/post-content" value="string('empty-instance')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/controlGroup" value="string('E')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/dsLocation" value="string(xxforms:instance('ModelTypes')//ModelType[@fullname = xxforms:instance('object-ingest-parameters')/objectType]/@defaultThumbnail)"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/altIDs" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/dsLabel" value="concat(replace(xxforms:instance('newPID'), ':', '_'), '_', 'THUMBNAIL')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/versionable" value="string('false')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/dsState" value="string('A')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/formatURI" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/checksumType" value="string('MD5')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/checksum" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/mimeType" value="string('image/png')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/logMessage" value="concat('Initial ', xxforms:instance('addDatastream-parameters')/dsID, ' datastream')"/>
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true"
                         >
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('addDatastream-parameters')/PID, '/datastreams/', xxforms:instance('addDatastream-parameters')/dsID)"/>
            <xxforms:context name="dsID" value="xxforms:instance('addDatastream-parameters')/dsID"/>
            <xxforms:context name="apiMethod" value="string('addDatastream')"/>
            <xxforms:context name="httpMethod" value="string('post')"/>
            <xxforms:context name="mode" value="string('')"/>
            <xxforms:context name="destination-instance" value="string('')"/>
            <xxforms:context name="clear-destination-instance" value="string('')"/>
            <xxforms:context name="parameters" value="string('addDatastream-parameters')"/>
        </xforms:dispatch>

        <!-- Add PARENT-QUERY -->
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/PID" value="xxforms:instance('newPID')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/dsID" value="string('PARENT-QUERY')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/post-content" value="string('empty-instance')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/controlGroup" value="string('E')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/dsLocation" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('newPID'), '/methods/vudl-system:CoreModelService/generateParentQuery')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/altIDs" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/dsLabel" value="concat(replace(xxforms:instance('newPID'), ':', '_'), '_', 'PARENT-QUERY')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/versionable" value="string('false')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/dsState" value="string('A')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/formatURI" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/checksumType" value="string('DISABLED')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/checksum" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/mimeType" value="string('text/plain')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/logMessage" value="concat('Initial ', xxforms:instance('addDatastream-parameters')/dsID, ' datastream')"/>
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true"
                         >
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('addDatastream-parameters')/PID, '/datastreams/', xxforms:instance('addDatastream-parameters')/dsID)"/>
            <xxforms:context name="dsID" value="xxforms:instance('addDatastream-parameters')/dsID"/>
            <xxforms:context name="apiMethod" value="string('addDatastream')"/>
            <xxforms:context name="httpMethod" value="string('post')"/>
            <xxforms:context name="mode" value="string('')"/>
            <xxforms:context name="destination-instance" value="string('')"/>
            <xxforms:context name="clear-destination-instance" value="string('')"/>
            <xxforms:context name="parameters" value="string('addDatastream-parameters')"/>
        </xforms:dispatch>

        <!-- Add PARENT-LIST-RAW -->
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/PID" value="xxforms:instance('newPID')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/dsID" value="string('PARENT-LIST-RAW')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/post-content" value="string('empty-instance')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/controlGroup" value="string('E')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/dsLocation" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('newPID'), '/methods/vudl-system:CoreModelService/executeParentQuery')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/altIDs" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/dsLabel" value="concat(replace(xxforms:instance('newPID'), ':', '_'), '_', 'PARENT-LIST-RAW')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/versionable" value="string('false')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/dsState" value="string('A')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/formatURI" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/checksumType" value="string('DISABLED')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/checksum" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/mimeType" value="string('text/xml')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/logMessage" value="concat('Initial ', xxforms:instance('addDatastream-parameters')/dsID, ' datastream')"/>
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true"
                         >
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('addDatastream-parameters')/PID, '/datastreams/', xxforms:instance('addDatastream-parameters')/dsID)"/>
            <xxforms:context name="dsID" value="xxforms:instance('addDatastream-parameters')/dsID"/>
            <xxforms:context name="apiMethod" value="string('addDatastream')"/>
            <xxforms:context name="httpMethod" value="string('post')"/>
            <xxforms:context name="mode" value="string('')"/>
            <xxforms:context name="destination-instance" value="string('')"/>
            <xxforms:context name="clear-destination-instance" value="string('')"/>
            <xxforms:context name="parameters" value="string('addDatastream-parameters')"/>
        </xforms:dispatch>

        <!-- Add PARENT-LIST -->
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/PID" value="xxforms:instance('newPID')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/dsID" value="string('PARENT-LIST')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/post-content" value="string('empty-instance')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/controlGroup" value="string('E')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/dsLocation" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('newPID'), '/methods/vudl-system:CoreModelService/formatParentQueryResult')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/altIDs" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/dsLabel" value="concat(replace(xxforms:instance('newPID'), ':', '_'), '_', 'PARENT-LIST')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/versionable" value="string('false')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/dsState" value="string('A')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/formatURI" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/checksumType" value="string('DISABLED')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/checksum" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/mimeType" value="string('text/xml')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/logMessage" value="concat('Initial ', xxforms:instance('addDatastream-parameters')/dsID, ' datastream')"/>
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true"
                         >
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('addDatastream-parameters')/PID, '/datastreams/', xxforms:instance('addDatastream-parameters')/dsID)"/>
            <xxforms:context name="dsID" value="xxforms:instance('addDatastream-parameters')/dsID"/>
            <xxforms:context name="apiMethod" value="string('addDatastream')"/>
            <xxforms:context name="httpMethod" value="string('post')"/>
            <xxforms:context name="mode" value="string('')"/>
            <xxforms:context name="destination-instance" value="string('')"/>
            <xxforms:context name="clear-destination-instance" value="string('')"/>
            <xxforms:context name="parameters" value="string('addDatastream-parameters')"/>
        </xforms:dispatch>

    </xforms:action>
    
    <!-- ************************************* -->
    <!-- CoreModel Ingest Refresh after insert -->
    <!-- ************************************* -->
    <xforms:action ev:event="CoreModel-ingest-update">
        <!-- If parents STRUCTMAP exists -->
        <xforms:action if="xxforms:instance('PIDmetadata')/object[@pid = xxforms:instance('object-ingest-parameters')/parentPID]/access:objectDatastreams/access:datastream[@dsid = 'STRUCTMAP']">
        
        <!-- Add line to current/parent STRUCTMAP (STRUCTMAP-ingest-instance)-->
        <!-- at="last()" -->
        <xforms:action if="xxforms:instance('object-ingest-parameters')/position = 'last'">
            <xforms:insert context="xxforms:instance('STRUCTMAP-ingest-instance')/METS:structMap"
                           nodeset="METS:div"
                           origin="xxforms:instance('STRUCTMAP-div-template')"
                           at="last()"
                           position="after"
                           />
        </xforms:action>
        <!-- at="first" -->
        <xforms:action if="xxforms:instance('object-ingest-parameters')/position = 'first'">
            <xforms:insert context="xxforms:instance('STRUCTMAP-ingest-instance')/METS:structMap"
                           nodeset="METS:div"
                           origin="xxforms:instance('STRUCTMAP-div-template')"
                           at="1"
                           position="before"
                           />
        </xforms:action>
         <!-- at="at" -->
        <xforms:action if="xxforms:instance('object-ingest-parameters')/position = 'at'">
            <xforms:insert context="xxforms:instance('STRUCTMAP-ingest-instance')/METS:structMap"
                           nodeset="METS:div"
                           origin="xxforms:instance('STRUCTMAP-div-template')"
                           at="xxforms:instance('object-ingest-parameters')/at"
                           position="before"
                           />
        </xforms:action>

        <xforms:setvalue ref="xxforms:instance('STRUCTMAP-ingest-instance')//METS:div/METS:fptr[@FILEID='']/@FILEID" value="xxforms:instance('newPID')"/>

        <!-- update/touch siblings affected by adding self into their STRUCTMAP - so they get updated in Solr -->
        <xforms:action xxforms:iterate="xxforms:instance('STRUCTMAP-ingest-instance')//METS:div/METS:fptr[@FILEID = xxforms:instance('newPID')]/../following-sibling::*">
            <xxforms:variable name="refreshPid" value="./METS:fptr/@FILEID"/>
            <xforms:action if="$refreshPid">
                <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/PID" value="$refreshPid"/>
                <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/label" value="string('')"/>
                <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/ownerId" value="string('')"/>
                <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/state" value="string('')"/>
                <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/logMessage" value="string('Position in parent STRUCTMAP as changed')"/>
                <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/lastModifiedDate" value="now()"/>
                <!-- modifyObject -->
                <xforms:dispatch name="performAPIRequest" 
                                 target="FedoraAPI-helper"
                                 xxforms:show-progress="true">
                    <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('modifyObject-parameters')/PID)"/>
                    <xxforms:context name="apiMethod" value="string('modifyObject')"/>
                    <xxforms:context name="httpMethod" value="string('put')"/>
                    <xxforms:context name="mode" value="string('')"/>
                    <xxforms:context name="destination-instance" value="string('')"/>
                    <xxforms:context name="clear-destination-instance" value="string('')"/>
                    <xxforms:context name="post-content" value="string('')"/>
                    <xxforms:context name="parameters" value="string('modifyObject-parameters')"/>
                </xforms:dispatch>
            </xforms:action>
        </xforms:action>

        <!-- update current/parent STRUCTMAP -->
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/PID" value="xxforms:instance('object-ingest-parameters')/parentPID"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/dsID" value="string('STRUCTMAP')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/post-content" value="string('STRUCTMAP-ingest-instance')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsLocation" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/altIDs" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsLabel" value="xxforms:instance('STRUCTMAP-ingest-datastream-instance')//management:dsLabel"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/versionable" value="xxforms:instance('STRUCTMAP-ingest-datastream-instance')//management:dsVersionable"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsState" value="xxforms:instance('STRUCTMAP-ingest-datastream-instance')//management:dsState"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/formatURI" value="xxforms:instance('STRUCTMAP-ingest-datastream-instance')//management:dsFormatURI"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/checksumType" value="xxforms:instance('STRUCTMAP-ingest-datastream-instance')//management:dsChecksumType"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/checksum" value="xxforms:instance('STRUCTMAP-ingest-datastream-instance')//management:dsChecksum"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/mimeType" value="xxforms:instance('STRUCTMAP-ingest-datastream-instance')//management:dsMIME"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/logMessage" value="string('Modified STRUCTMAP Datastream')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/ignoreContent" value="string('false')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/lastModifiedDate" value="now()"/>
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('modifyDatastream-parameters')/PID, '/datastreams/', xxforms:instance('modifyDatastream-parameters')/dsID)"/>
            <xxforms:context name="dsID" value="xxforms:instance('modifyDatastream-parameters')/dsID"/>
            <xxforms:context name="apiMethod" value="string('modifyDatastream')"/>
            <xxforms:context name="httpMethod" value="string('put')"/>
            <xxforms:context name="mode" value="string('')"/>
            <xxforms:context name="destination-instance" value="string('')"/>
            <xxforms:context name="clear-destination-instance" value="string('')"/>
            <xxforms:context name="post-content" value="xxforms:instance('modifyDatastream-parameters')/post-content"/>
            <xxforms:context name="parameters" value="string('modifyDatastream-parameters')"/>
        </xforms:dispatch>
        
        </xforms:action>
        
        <!-- update parent ResourceCollection if one exists -->
        <xforms:dispatch name="update-parent-resource"
                         target="CoreModel-helper">
            <xxforms:context name="PID" value="xxforms:instance('newPID')"/>
        </xforms:dispatch>
                    
    </xforms:action>
    
    <!-- TODO: I don't think this is necessary anymore -->
    <xforms:action ev:event="refresh-after-object-ingest">
        <!-- Refresh Page -->
        <xforms:action if="xxforms:instance('currentPID') = xxforms:instance('control-menu-parameters')/PID">
            <xforms:message>Refresh Page</xforms:message>
        </xforms:action>
        <!-- Refresh Browse/Tree -->
        <xforms:action if="not(xxforms:instance('currentPID') = xxforms:instance('control-menu-parameters')/PID)">
            <xforms:message>Refresh Browse/Tree</xforms:message>
        </xforms:action>
    </xforms:action>
    
    <!--  -->
    <xforms:action ev:event="launch-find-object">
        <xxforms:show dialog="find-object-dialog"/>
    </xforms:action>

    <!-- Upload/Attach datastream -->
    <xforms:action ev:event="upload-attach-datastream" if="xxforms:instance('upload-DATA')/file/@filename != ''">

        <!-- -->
        <xxforms:variable name="file-location" value="substring-before(xxforms:instance('upload-DATA')/file, '?')"/>

        <!-- Purge {DATA} Datastream (if it exists) -->
        <xforms:setvalue ref="xxforms:instance('purgeDatastream-parameters')/PID" value="xxforms:instance('upload-DATA-parameters')/PID"/>
        <xforms:setvalue ref="xxforms:instance('purgeDatastream-parameters')/dsID" value="xxforms:instance('upload-DATA-parameters')/dsID"/>
        <xforms:setvalue ref="xxforms:instance('purgeDatastream-parameters')/parameters/startDT" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('purgeDatastream-parameters')/parameters/endDT" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('purgeDatastream-parameters')/parameters/logMessage" value="concat('Replacing ', xxforms:instance('purgeDatastream-parameters')/dsID)"/>
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true"
                         if="xxforms:instance('PIDmetadata')/object[@pid = xxforms:instance('purgeDatastream-parameters')/PID]//access:datastream[@dsid = xxforms:instance('purgeDatastream-parameters')/dsID]">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('purgeDatastream-parameters')/PID, '/datastreams/', xxforms:instance('purgeDatastream-parameters')/dsID)"/>
            <xxforms:context name="dsID" value="xxforms:instance('purgeDatastream-parameters')/dsID"/>
            <xxforms:context name="apiMethod" value="string('purgeDatastream')"/>
            <xxforms:context name="httpMethod" value="string('delete')"/>
            <xxforms:context name="mode" value="string('')"/>
            <xxforms:context name="destination-instance" value="string('')"/>
            <xxforms:context name="clear-destination-instance" value="string('')"/>
            <xxforms:context name="parameters" value="string('purgeDatastream-parameters')"/>
        </xforms:dispatch>
        
        <!-- Prepare new parameters for {DATA} -->
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/PID" value="xxforms:instance('upload-DATA-parameters')/PID"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/dsID" value="xxforms:instance('upload-DATA-parameters')/dsID"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/post-content" value="string('empty-instance')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/controlGroup" value="string('M')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/dsLocation" value="$file-location"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/altIDs" value="string('')"/>
        <!-- <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/dsLabel" value="concat(xxforms:instance('upload-DATA-parameters')/dsID, ' for this Object')"/> -->
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/dsLabel" value="concat(replace(xxforms:instance('upload-DATA-parameters')/PID, ':', '_'), '_', xxforms:instance('upload-DATA-parameters')/dsID)"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/versionable" value="string('false')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/dsState" value="string('A')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/formatURI" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/checksumType" value="string('MD5')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/checksum" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/mimeType" value="xxforms:instance('upload-DATA')/file/@mediatype"/>
        <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/logMessage" value="concat('Modified ', xxforms:instance('addDatastream-parameters')/dsID, ' datastream')"/>
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true"
                         >
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('addDatastream-parameters')/PID, '/datastreams/', xxforms:instance('addDatastream-parameters')/dsID)"/>
            <xxforms:context name="dsID" value="xxforms:instance('addDatastream-parameters')/dsID"/>
            <xxforms:context name="apiMethod" value="string('addDatastream')"/>
            <xxforms:context name="httpMethod" value="string('post')"/>
            <xxforms:context name="mode" value="string('')"/>
            <xxforms:context name="destination-instance" value="string('')"/>
            <xxforms:context name="clear-destination-instance" value="string('')"/>
            <xxforms:context name="parameters" value="string('addDatastream-parameters')"/>
        </xforms:dispatch>
        
        <!-- Once uploaded... -->
        <!-- if xxforms:instance('addDatastream-parameters')/dsID = MASTER 
             AND the checkbox is checked
             purge MASTER-MD (if it exists)
                  if="xxforms:instance('PIDmetadata')/object[@pid = xxforms:instance('purgeDatastream-parameters')/PID]//access:datastream[@dsid = xxforms:instance('purgeDatastream-parameters')/dsID]
             post new MASTER-MD
        -->
        <!-- Get FITS info -->
        <xforms:setvalue ref="xxforms:instance('FitsRequest-parameters')/destination-instance" value="string('upload-DATA-metadata')"/>
        <xforms:setvalue ref="xxforms:instance('FitsRequest-parameters')/parameters/url" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('upload-DATA-parameters')/PID, '/datastreams/', xxforms:instance('upload-DATA-parameters')/dsID, '/content')"/>
        <xforms:send submission="FitsRequest" model="Fits-helper"/>

        <!-- update MIME with data from FITS -->
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/PID" value="xxforms:instance('upload-DATA-parameters')/PID"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/dsID" value="xxforms:instance('upload-DATA-parameters')/dsID"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsLocation" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/altIDs" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsLabel" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/versionable" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsState" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/formatURI" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/checksumType" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/checksum" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/mimeType" value="xxforms:instance('upload-DATA-metadata')//fits:identification/fits:identity[not(@format = 'FPX')][1]/@mimetype"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/logMessage" value="concat('Updated MIME for ', xxforms:instance('upload-DATA-parameters')/dsID,' based on FITS')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/ignoreContent" value="string('true')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/lastModifiedDate" value="now()"/>
        <!-- <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/post-content" value="string('empty-instance')"/> -->
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/post-content" value="string('RELS-EXT-dialog-instance')"/>
        <xforms:dispatch name="performAPIRequest"
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('modifyDatastream-parameters')/PID, '/datastreams/', xxforms:instance('modifyDatastream-parameters')/dsID)"/>
            <xxforms:context name="dsID" value="xxforms:instance('modifyDatastream-parameters')/dsID"/>
            <xxforms:context name="apiMethod" value="string('modifyDatastream')"/>
            <xxforms:context name="httpMethod" value="string('put')"/>
            <xxforms:context name="mode" value="string('')"/>
            <xxforms:context name="destination-instance" value="string('')"/>
            <xxforms:context name="clear-destination-instance" value="string('')"/>
            <xxforms:context name="post-content" value="xxforms:instance('modifyDatastream-parameters')/post-content"/>
            <xxforms:context name="parameters" value="string('modifyDatastream-parameters')"/>
        </xforms:dispatch>
        
        <!-- Create MASTER-MD id uploaded MASTER -->
        <xforms:action if="xxforms:instance('upload-DATA-parameters')/dsID = 'MASTER'">
            <!-- Purge {DATA} Datastream (if it exists) -->
            <xforms:setvalue ref="xxforms:instance('purgeDatastream-parameters')/PID" value="xxforms:instance('upload-DATA-parameters')/PID"/>
            <xforms:setvalue ref="xxforms:instance('purgeDatastream-parameters')/dsID" value="string('MASTER-MD')"/>
            <xforms:setvalue ref="xxforms:instance('purgeDatastream-parameters')/parameters/startDT" value="string('')"/>
            <xforms:setvalue ref="xxforms:instance('purgeDatastream-parameters')/parameters/endDT" value="string('')"/>
            <xforms:setvalue ref="xxforms:instance('purgeDatastream-parameters')/parameters/logMessage" value="string('Replacing MASTER-MD')"/>
            <xforms:dispatch name="performAPIRequest" 
                             target="FedoraAPI-helper"
                             xxforms:show-progress="true"
                             if="xxforms:instance('PIDmetadata')/object[@pid = xxforms:instance('purgeDatastream-parameters')/PID]//access:datastream[@dsid = 'MASTER-MD']">
                <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('purgeDatastream-parameters')/PID, '/datastreams/', xxforms:instance('purgeDatastream-parameters')/dsID)"/>
                <xxforms:context name="dsID" value="xxforms:instance('purgeDatastream-parameters')/dsID"/>
                <xxforms:context name="apiMethod" value="string('purgeDatastream')"/>
                <xxforms:context name="httpMethod" value="string('delete')"/>
                <xxforms:context name="mode" value="string('')"/>
                <xxforms:context name="destination-instance" value="string('')"/>
                <xxforms:context name="clear-destination-instance" value="string('')"/>
                <xxforms:context name="parameters" value="string('purgeDatastream-parameters')"/>
            </xforms:dispatch>
            
            <!-- Prepare new parameters for {DATA} -->
            <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/PID" value="xxforms:instance('upload-DATA-parameters')/PID"/>
            <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/dsID" value="string('MASTER-MD')"/>
            <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/post-content" value="string('upload-DATA-metadata')"/>
            <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/controlGroup" value="string('M')"/>
            <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/dsLocation" value="string('')"/>
            <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/altIDs" value="string('')"/>
            <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/dsLabel" value="concat(replace(xxforms:instance('upload-DATA-parameters')/PID, ':', '_'), '_', 'MASTER-MD')"/>
            <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/versionable" value="string('false')"/>
            <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/dsState" value="string('A')"/>
            <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/formatURI" value="string('')"/>
            <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/checksumType" value="string('MD5')"/>
            <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/checksum" value="string('')"/>
            <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/mimeType" value="string('text/xml')"/>
            <xforms:setvalue ref="xxforms:instance('addDatastream-parameters')/parameters/logMessage" value="concat('Modified ', xxforms:instance('addDatastream-parameters')/dsID, ' datastream, created new MASTER-MD')"/>
            <!-- Send add Request (Post new datastream file) -->
            <xforms:dispatch name="performAPIRequest" 
                             target="FedoraAPI-helper"
                             xxforms:show-progress="true"
                             >
                <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('addDatastream-parameters')/PID, '/datastreams/', xxforms:instance('addDatastream-parameters')/dsID)"/>
                <xxforms:context name="dsID" value="xxforms:instance('addDatastream-parameters')/dsID"/>
                <xxforms:context name="apiMethod" value="string('addDatastream')"/>
                <xxforms:context name="httpMethod" value="string('post')"/>
                <xxforms:context name="mode" value="string('')"/>
                <xxforms:context name="destination-instance" value="string('')"/>
                <xxforms:context name="clear-destination-instance" value="string('')"/>
                <xxforms:context name="parameters" value="string('addDatastream-parameters')"/>
            </xforms:dispatch>
        </xforms:action>

        <xforms:dispatch name="refresh-PIDmetadata"
                         target="CoreModel-helper"
                         >
            <xxforms:context name="PID" select="xxforms:instance('upload-DATA-parameters')/PID"/>
            <xxforms:context name="mode" select="string('asynchronous')"/>
            <xxforms:context name="stats" select="string('true')"/>
        </xforms:dispatch>

        <!-- update parent ResourceCollection if one exists -->
        <xforms:dispatch name="update-parent-resource"
                         target="CoreModel-helper">
            <xxforms:context name="PID" value="xxforms:instance('upload-DATA-parameters')/PID"/>
        </xforms:dispatch>

        <!-- clear upload info -->
        <xforms:setvalue ref="xxforms:instance('upload-DATA')/file/@filename" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA')/file/@mediatype" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA')/file/@size" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA')/file" value="string('')"/>
        
        <!-- Close Dialog -->
        <xxforms:hide dialog="attach-datastream-dialog"/>
    </xforms:action>
                
    
    <!-- -->
    <xforms:action ev:event="moveUp">
        <xxforms:variable name="pid" value="event('pid')"/>
        <xxforms:variable name="prevPid" value="event('prevPid')"/>
        
        <!-- update STRUCTMAP -->
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/PID" value="xxforms:instance('edit-members-parameters')/PID"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/dsID" value="string('STRUCTMAP')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/post-content" value="string('STRUCTMAP-dialog-instance')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsLocation" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/altIDs" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsLabel" value="xxforms:instance('STRUCTMAP-dialog-datastream-instance')//management:dsLabel"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/versionable" value="xxforms:instance('STRUCTMAP-dialog-datastream-instance')//management:dsVersionable"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsState" value="xxforms:instance('STRUCTMAP-dialog-datastream-instance')//management:dsState"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/formatURI" value="xxforms:instance('STRUCTMAP-dialog-datastream-instance')//management:dsFormatURI"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/checksumType" value="xxforms:instance('STRUCTMAP-dialog-datastream-instance')//management:dsChecksumType"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/checksum" value="xxforms:instance('STRUCTMAP-dialog-datastream-instance')//management:dsChecksum"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/mimeType" value="xxforms:instance('STRUCTMAP-dialog-datastream-instance')//management:dsMIME"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/logMessage" value="string('Altered STRUCTMAP ORDER')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/ignoreContent" value="string('false')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/lastModifiedDate" value="now()"/>
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('modifyDatastream-parameters')/PID, '/datastreams/', xxforms:instance('modifyDatastream-parameters')/dsID)"/>
            <xxforms:context name="dsID" value="xxforms:instance('modifyDatastream-parameters')/dsID"/>
            <xxforms:context name="apiMethod" value="string('modifyDatastream')"/>
            <xxforms:context name="httpMethod" value="string('put')"/>
            <xxforms:context name="mode" value="string('')"/>
            <xxforms:context name="destination-instance" value="string('')"/>
            <xxforms:context name="clear-destination-instance" value="string('')"/>
            <xxforms:context name="post-content" value="xxforms:instance('modifyDatastream-parameters')/post-content"/>
            <xxforms:context name="parameters" value="string('modifyDatastream-parameters')"/>
        </xforms:dispatch>
        
        <!-- update/touch the object that has been moved. Its index has changed and needs to be reindexed in Solr -->
        <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/PID" value="$pid"/>
        <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/label" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/ownerId" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/state" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/logMessage" value="string('Position in parent STRUCTMAP as changed')"/>
        <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/lastModifiedDate" value="now()"/>
        <!-- modifyObject -->
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('modifyObject-parameters')/PID)"/>
            <xxforms:context name="apiMethod" value="string('modifyObject')"/>
            <xxforms:context name="httpMethod" value="string('put')"/>
            <xxforms:context name="mode" value="string('')"/>
            <xxforms:context name="destination-instance" value="string('')"/>
            <xxforms:context name="clear-destination-instance" value="string('')"/>
            <xxforms:context name="post-content" value="string('')"/>
            <xxforms:context name="parameters" value="string('modifyObject-parameters')"/>
        </xforms:dispatch>
        
        <!-- if there is a prevPid, update/touch it also so its position gets updated in Solr -->
        <xforms:action if="$prevPid">
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/PID" value="$prevPid"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/label" value="string('')"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/ownerId" value="string('')"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/state" value="string('')"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/logMessage" value="string('Position in parent STRUCTMAP as changed')"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/lastModifiedDate" value="now()"/>
            <!-- modifyObject -->
            <xforms:dispatch name="performAPIRequest" 
                             target="FedoraAPI-helper"
                             xxforms:show-progress="true">
                <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('modifyObject-parameters')/PID)"/>
                <xxforms:context name="apiMethod" value="string('modifyObject')"/>
                <xxforms:context name="httpMethod" value="string('put')"/>
                <xxforms:context name="mode" value="string('')"/>
                <xxforms:context name="destination-instance" value="string('')"/>
                <xxforms:context name="clear-destination-instance" value="string('')"/>
                <xxforms:context name="post-content" value="string('')"/>
                <xxforms:context name="parameters" value="string('modifyObject-parameters')"/>
            </xforms:dispatch>
        </xforms:action>
        
        <!-- update parent ResourceCollection if one exists -->
        <xforms:dispatch name="update-parent-resource"
                         target="CoreModel-helper">
            <xxforms:context name="PID" value="$pid"/>
        </xforms:dispatch>
    
        <!-- If the node moves out of the page refresh the metadata -->
        <xforms:dispatch name="load-dialog-MEMBER-TABLE-metadata"
                         target="CoreModel-helper"
                         delay="1"
                         />
    

    </xforms:action>
    
    <!-- -->
    <xforms:action ev:event="moveDown">
        <xxforms:variable name="pid" value="event('pid')"/>
        <xxforms:variable name="nextPid" value="event('nextPid')"/>
        
        <!-- update STRUCTMAP -->
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/PID" value="xxforms:instance('edit-members-parameters')/PID"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/dsID" value="string('STRUCTMAP')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/post-content" value="string('STRUCTMAP-dialog-instance')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsLocation" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/altIDs" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsLabel" value="xxforms:instance('STRUCTMAP-dialog-datastream-instance')//management:dsLabel"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/versionable" value="xxforms:instance('STRUCTMAP-dialog-datastream-instance')//management:dsVersionable"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/dsState" value="xxforms:instance('STRUCTMAP-dialog-datastream-instance')//management:dsState"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/formatURI" value="xxforms:instance('STRUCTMAP-dialog-datastream-instance')//management:dsFormatURI"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/checksumType" value="xxforms:instance('STRUCTMAP-dialog-datastream-instance')//management:dsChecksumType"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/checksum" value="xxforms:instance('STRUCTMAP-dialog-datastream-instance')//management:dsChecksum"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/mimeType" value="xxforms:instance('STRUCTMAP-dialog-datastream-instance')//management:dsMIME"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/logMessage" value="string('Altered STRUCTMAP ORDER')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/ignoreContent" value="string('false')"/>
        <xforms:setvalue ref="xxforms:instance('modifyDatastream-parameters')/parameters/lastModifiedDate" value="now()"/>
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('modifyDatastream-parameters')/PID, '/datastreams/', xxforms:instance('modifyDatastream-parameters')/dsID)"/>
            <xxforms:context name="dsID" value="xxforms:instance('modifyDatastream-parameters')/dsID"/>
            <xxforms:context name="apiMethod" value="string('modifyDatastream')"/>
            <xxforms:context name="httpMethod" value="string('put')"/>
            <xxforms:context name="mode" value="string('')"/>
            <xxforms:context name="destination-instance" value="string('')"/>
            <xxforms:context name="clear-destination-instance" value="string('')"/>
            <xxforms:context name="post-content" value="xxforms:instance('modifyDatastream-parameters')/post-content"/>
            <xxforms:context name="parameters" value="string('modifyDatastream-parameters')"/>
        </xforms:dispatch>
    
        <!-- update/touch the object that has been moved. Its index has changed and needs to be reindexed in Solr -->
        <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/PID" value="$pid"/>
        <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/label" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/ownerId" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/state" value="string('')"/>
        <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/logMessage" value="string('Position in parent STRUCTMAP as changed')"/>
        <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/lastModifiedDate" value="now()"/>
        <!-- modifyObject -->
        <xforms:dispatch name="performAPIRequest" 
                         target="FedoraAPI-helper"
                         xxforms:show-progress="true">
            <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('modifyObject-parameters')/PID)"/>
            <xxforms:context name="apiMethod" value="string('modifyObject')"/>
            <xxforms:context name="httpMethod" value="string('put')"/>
            <xxforms:context name="mode" value="string('')"/>
            <xxforms:context name="destination-instance" value="string('')"/>
            <xxforms:context name="clear-destination-instance" value="string('')"/>
            <xxforms:context name="post-content" value="string('')"/>
            <xxforms:context name="parameters" value="string('modifyObject-parameters')"/>
        </xforms:dispatch>
        
        <!-- if there is a nextPid, update/touch it so its position gets updated in Solr -->
        <xforms:action if="$nextPid">
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/PID" value="$nextPid"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/label" value="string('')"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/ownerId" value="string('')"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/state" value="string('')"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/logMessage" value="string('Position in parent STRUCTMAP as changed')"/>
            <xforms:setvalue ref="xxforms:instance('modifyObject-parameters')/parameters/lastModifiedDate" value="now()"/>
            <!-- modifyObject -->
            <xforms:dispatch name="performAPIRequest" 
                             target="FedoraAPI-helper"
                             xxforms:show-progress="true">
                <xxforms:context name="resourceURL" value="concat(xxforms:instance('config-instance')/fedora/APIurl, ':', xxforms:instance('config-instance')/fedora/APIport, '/fedora/objects/', xxforms:instance('modifyObject-parameters')/PID)"/>
                <xxforms:context name="apiMethod" value="string('modifyObject')"/>
                <xxforms:context name="httpMethod" value="string('put')"/>
                <xxforms:context name="mode" value="string('')"/>
                <xxforms:context name="destination-instance" value="string('')"/>
                <xxforms:context name="clear-destination-instance" value="string('')"/>
                <xxforms:context name="post-content" value="string('')"/>
                <xxforms:context name="parameters" value="string('modifyObject-parameters')"/>
            </xforms:dispatch>
        </xforms:action>
        
        <!-- update parent ResourceCollection if one exists -->
        <xforms:dispatch name="update-parent-resource"
                         target="CoreModel-helper">
            <xxforms:context name="PID" value="$pid"/>
        </xforms:dispatch>
        
        <!-- -->
        <xforms:dispatch name="load-dialog-MEMBER-TABLE-metadata"
                         target="CoreModel-helper"
                         delay="1"
                         />
                                 
    </xforms:action>
    
    <!--  -->
    <xforms:action ev:event="launch-control-menu">
        <xxforms:hide dialog="control-menu-dialog"/>
        <xxforms:show dialog="control-menu-dialog" neighbor="{xxforms:instance('control-menu-parameters')/trigger-id}"/>
    </xforms:action>
    
    <!--  -->
    <xforms:action ev:event="launch-control-menu-simple">
        <xxforms:hide dialog="control-menu-simple-dialog"/>
        <xxforms:show dialog="control-menu-simple-dialog" neighbor="{xxforms:instance('control-menu-parameters')/trigger-id}"/>
    </xforms:action>
    
    <!--  -->
    <xforms:action ev:event="launch-add-object">
        <xxforms:show dialog="add-object-dialog"/>
    </xforms:action>
    
    <!--  -->
    <xforms:action ev:event="launch-DC">
        <xxforms:show dialog="edit-DC-dialog"/>
    </xforms:action>
    
    <xforms:action ev:event="launch-DC-description">
        <xxforms:show dialog="edit-DC-description-dialog"/>
    </xforms:action>
    
    <xforms:action ev:event="launch-DC-clone">
        <xxforms:show dialog="edit-DC-clone-dialog"/>
    </xforms:action>
    
    <!--  -->
    <xforms:action ev:event="launch-RELS-EXT">
        <xxforms:show dialog="edit-RELS-EXT-dialog"/>
    </xforms:action>
    <xforms:action ev:event="launch-add-isMemberOf">
        <xxforms:show dialog="add-isMemberOf-dialog"/>
    </xforms:action>
    
    <!--  -->
    <xforms:action ev:event="launch-edit-members">
        <xxforms:show dialog="edit-members-dialog"/>
    </xforms:action>
    <xforms:action ev:event="launch-edit-ordered-members">
        <xxforms:show dialog="edit-ordered-members-dialog"/>
    </xforms:action>
    
    <!--  -->
    <xforms:action ev:event="launch-edit-object">
        <xxforms:show dialog="edit-object-dialog"/>
    </xforms:action>
    
    <!--  -->
    <xforms:action ev:event="launch-purge-object">
        <xxforms:show dialog="purge-object-dialog"/>
    </xforms:action>
    
    <!--  -->
    <xforms:action ev:event="launch-edit-datastreams">
        <xxforms:show dialog="edit-datastreams-dialog"/>
    </xforms:action>
    
    <!--  -->
    <xforms:action ev:event="launch-view-object">
        <xxforms:show dialog="view-object-dialog"/>
    </xforms:action>
    
    <!--  -->
    <xforms:action ev:event="launch-confirm-delete-datastream">
        <xxforms:show dialog="confirm-delete-datastream-dialog"/>
    </xforms:action>
    
    <!--  -->
    <xforms:action ev:event="launch-attach-datastream">
        <xxforms:show dialog="attach-datastream-dialog"/>
    </xforms:action>
    
    <!--  -->
    <xforms:action ev:event="launch-edit-coordinates">
        <xxforms:show dialog="edit-coordinates-dialog"/>
    </xforms:action>
    
    <!-- CoreModel DS's -->
    <xforms:action ev:event="edit-DS-THUMBNAIL">
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/PID" value="event('datastreamPID')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/dsID" value="event('dsID')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/controlGroup" value="string('M')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/methodLevel" value="string('child')"/>
        <xforms:dispatch name="launch-attach-datastream" target="CoreModel-helper"/>
    </xforms:action>
    <xforms:action ev:event="edit-DS-LICENSE">
        <xforms:setvalue ref="xxforms:instance('edit-license-parameters')/PID" value="event('datastreamPID')"/>
        <xxforms:show dialog="edit-license-dialog"/>
    </xforms:action>
    <xforms:action ev:event="edit-DS-FESLPOLICY">
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/PID" value="event('datastreamPID')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/dsID" value="event('dsID')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/controlGroup" value="string('M')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/methodLevel" value="string('child')"/>
        <xforms:dispatch name="launch-attach-datastream" target="CoreModel-helper"/>
    </xforms:action>
    
    <!-- CollectionModel DS's -->
    <xforms:action ev:event="edit-DS-STRUCTMAP">
        <xforms:setvalue ref="xxforms:instance('edit-members-parameters')/PID" value="event('datastreamPID')"/>
        <xforms:setvalue ref="xxforms:instance('edit-members-parameters')/edit-in-line" value="string('false')"/>
        <xforms:setvalue ref="xxforms:instance('edit-members-parameters')/ordered" value="string('true')"/>
        <xforms:setvalue ref="xxforms:instance('edit-members-parameters')/memberContainer" value="string('STRUCTMAP-dialog-instance')"/>
        <xforms:setvalue ref="xxforms:instance('edit-members-parameters')/memberContainerNode" value="string('METS:div')"/>
        <xforms:dispatch name="launch-edit-ordered-members" target="CoreModel-helper"/>
    </xforms:action>
    
    <!-- ResourceCollection DS's -->
    <xforms:action ev:event="edit-DS-AGENTS">
        <xforms:setvalue ref="xxforms:instance('edit-agents-parameters')/PID" value="event('datastreamPID')"/>
        <xxforms:show dialog="edit-agents-dialog"/>
    </xforms:action>
    <xforms:action ev:event="edit-DS-PROCESS-MD">
        <xforms:setvalue ref="xxforms:instance('edit-process-md-parameters')/PID" value="event('datastreamPID')"/>
        <xxforms:show dialog="edit-process-md-dialog"/>
    </xforms:action>
    
    <!-- DataObject DS's -->
    <xforms:action ev:event="edit-DS-MASTER">
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/PID" value="event('datastreamPID')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/dsID" value="event('dsID')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/controlGroup" value="string('M')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/methodLevel" value="string('child')"/>
        <xforms:dispatch name="launch-attach-datastream" target="CoreModel-helper"/>
    </xforms:action>
    <xforms:action ev:event="edit-DS-MASTER-MD">
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/PID" value="event('datastreamPID')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/dsID" value="event('dsID')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/controlGroup" value="string('M')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/methodLevel" value="string('child')"/>
        <xforms:dispatch name="launch-attach-datastream" target="CoreModel-helper"/>
    </xforms:action>
    
    <!-- ImageData DS's -->
    <xforms:action ev:event="edit-DS-LARGE">
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/PID" value="event('datastreamPID')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/dsID" value="event('dsID')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/controlGroup" value="string('M')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/methodLevel" value="string('child')"/>
        <xforms:dispatch name="launch-attach-datastream" target="CoreModel-helper"/>
    </xforms:action>
    <xforms:action ev:event="edit-DS-MEDIUM">
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/PID" value="event('datastreamPID')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/dsID" value="event('dsID')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/controlGroup" value="string('M')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/methodLevel" value="string('child')"/>
        <xforms:dispatch name="launch-attach-datastream" target="CoreModel-helper"/>
    </xforms:action>
    <xforms:action ev:event="edit-DS-OCR-DIRTY">
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/PID" value="event('datastreamPID')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/dsID" value="event('dsID')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/controlGroup" value="string('M')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/methodLevel" value="string('child')"/>
        <xforms:dispatch name="launch-attach-datastream" target="CoreModel-helper"/>
    </xforms:action>
    <xforms:action ev:event="edit-DS-OCR-EDITED">
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/PID" value="event('datastreamPID')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/dsID" value="event('dsID')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/controlGroup" value="string('M')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/methodLevel" value="string('child')"/>
        <xforms:dispatch name="launch-attach-datastream" target="CoreModel-helper"/>
    </xforms:action>
    
    <!-- SegmentImage DS's-->
    <xforms:action ev:event="edit-DS-COORDINATES">
        <xforms:setvalue ref="xxforms:instance('edit-coordinates-parameters')/PID" value="event('datastreamPID')"/>
        <xforms:dispatch name="launch-edit-coordinates" target="CoreModel-helper"/>
    </xforms:action>
    
    <!-- AudioData DS's -->
    <xforms:action ev:event="edit-DS-MP3">
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/PID" value="event('datastreamPID')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/dsID" value="event('dsID')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/controlGroup" value="string('M')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/methodLevel" value="string('child')"/>
        <xforms:dispatch name="launch-attach-datastream" target="CoreModel-helper"/>
    </xforms:action>
    <xforms:action ev:event="edit-DS-WAV">
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/PID" value="event('datastreamPID')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/dsID" value="event('dsID')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/controlGroup" value="string('M')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/methodLevel" value="string('child')"/>
        <xforms:dispatch name="launch-attach-datastream" target="CoreModel-helper"/>
    </xforms:action>
    <xforms:action ev:event="edit-DS-OGG">
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/PID" value="event('datastreamPID')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/dsID" value="event('dsID')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/controlGroup" value="string('M')"/>
        <xforms:setvalue ref="xxforms:instance('upload-DATA-parameters')/methodLevel" value="string('child')"/>
        <xforms:dispatch name="launch-attach-datastream" target="CoreModel-helper"/>
    </xforms:action>

</xforms:model>